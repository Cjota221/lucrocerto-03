<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucro Certo - App</title>
    
    <!-- Google Fonts: Poppins (Títulos) e Open Sans (Textos) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CSS Reset & Base --- */
        :root {
            --pink: #db1472;
            --pink-light: #fce7f3;
            --gold: #f8b81f;
            --gold-light: #fbcd6a;
            --text-dark: #1f2937;
            --text-light: #4b5563;
            --background: #f9fafb;
            --white: #ffffff;
            --border-color: #e5e7eb;
            --success: #22c55e;
            --blue: #3b82f6;

            --font-primary: 'Poppins', sans-serif;
            --font-secondary: 'Open Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-secondary);
            background-color: var(--background);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
        }

        /* --- App Layout --- */
        #app-container { display: flex; min-height: 100vh; }
        #sidebar {
            width: 260px; background-color: var(--white); border-right: 1px solid var(--border-color);
            padding: 1.5rem; position: fixed; left: -260px; top: 0; height: 100%;
            transition: left 0.3s ease-in-out; z-index: 300; display: flex; flex-direction: column;
        }
        #sidebar.active { left: 0; }
        #main-content { flex-grow: 1; padding: 1.5rem; width: 100%; }
        
        #sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 299; 
        }
        #sidebar-overlay.active {
            display: block;
        }

        /* --- Sidebar Menu --- */
        .sidebar-header { font-family: var(--font-primary); font-size: 1.5rem; font-weight: 700; color: var(--pink); padding-left: 0.5rem; margin-bottom: 2rem; }
        .sidebar-nav { list-style: none; flex-grow: 1; }
        .sidebar-nav li a {
            display: flex; align-items: center; gap: 1rem; padding: 0.85rem 1rem; margin-bottom: 0.5rem;
            border-radius: 0.5rem; text-decoration: none; font-family: var(--font-primary); font-weight: 600;
            font-size: 0.95rem; color: var(--text-light); transition: background-color 0.2s ease, color 0.2s ease;
        }
        .sidebar-nav li a svg { width: 22px; height: 22px; }
        .sidebar-nav li a:hover { background-color: var(--pink-light); color: var(--pink); }
        .sidebar-nav li a.active { background-color: var(--pink); color: var(--white); box-shadow: 0 4px 6px -1px rgba(219, 20, 114, 0.3); }
        .sidebar-footer { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; }

        /* --- Header --- */
        .header {
            display: flex; align-items: center; background-image: linear-gradient(to right, var(--pink), var(--gold));
            color: var(--white); padding: 1rem 1.5rem; margin-bottom: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .header-title { font-family: var(--font-primary); font-size: 1.25rem; font-weight: 700; color: var(--white); }
        .menu-toggle { background: none; border: none; cursor: pointer; margin-right: 1rem; font-size: 1.5rem; color: var(--white); }
        
        /* --- Page Sections (for SPA) --- */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;}
        .page-title { font-family: var(--font-primary); font-size: 1.5rem; color: var(--text-dark); }

        /* --- Grid & Card Styles --- */
        .cards-grid { display: grid; gap: 1.5rem; grid-template-columns: 1fr; }
        @media (min-width: 1024px) {
             .cards-grid.dashboard-grid { grid-template-columns: repeat(3, 1fr); }
             .cards-grid.vendas-grid { grid-template-columns: 2fr 1fr; align-items: flex-start; }
        }
        @media (min-width: 768px) {
            .cards-grid.two-cols { grid-template-columns: repeat(2, 1fr); }
            .cards-grid.quick-actions-grid { grid-template-columns: repeat(4, 1fr); }
            .cards-grid.summary-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (min-width: 500px) and (max-width: 767px) {
             .cards-grid.summary-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 767px) {
             .cards-grid.quick-actions-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem;}
        }

        .card { background-color: var(--white); border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .card-title { font-family: var(--font-primary); font-weight: 600; font-size: 1.2rem; color: var(--text-dark); margin-bottom: 1rem; }
        .card-title-small { font-size: 1rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .card-value { font-family: var(--font-primary); font-weight: 700; font-size: 2rem; color: var(--pink); }
        .card-value-small { font-family: var(--font-primary); font-size: 1.5rem; color: var(--text-dark); }
        .info-card { background-color: var(--pink-light); padding: 1rem; border-radius: 0.5rem; }
        .info-card p { color: var(--pink); font-family: var(--font-secondary); }
        .info-card strong { font-family: var(--font-primary); }

        /* --- Button Styles --- */
        .btn {
            font-family: var(--font-primary); font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            border: none; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn:not(:disabled):hover { transform: translateY(-2px); }
        .btn:disabled { cursor: not-allowed; background-color: #d1d5db; color: #6b7280; }
        .btn-primary { background-color: var(--pink); color: var(--white); }
        .btn-primary:not(:disabled):hover { background-color: #be1265; }
        .btn-secondary { background-color: var(--pink-light); color: var(--pink); }
        .btn-secondary:not(:disabled):hover { background-color: #fbcfe8; }
        .btn-danger { background-color: var(--border-color); color: var(--text-light); }
        .btn-danger:hover { background-color: #d1d5db; }
        .btn-success { background-color: var(--success); color: var(--white); }
        .btn-success:not(:disabled):hover { background-color: #16a34a; }
        .btn-whatsapp { background-color: var(--success); color: var(--white); }
        .btn-whatsapp:not(:disabled):hover { background-color: #16a34a; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        
        .quick-action-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.75rem; background-image: linear-gradient(135deg, var(--pink), var(--gold)); color: var(--white); padding: 1.5rem 1rem; border-radius: 0.75rem; font-family: var(--font-primary); font-weight: 700; font-size: 1rem; text-decoration: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .quick-action-btn svg { width: 28px; height: 28px; }
        .quick-action-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        
        /* --- Form Styles --- */
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-family: var(--font-primary); font-weight: 600; margin-bottom: 0.5rem; color: var(--text-light); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;
            font-size: 1rem; font-family: var(--font-secondary);
        }
        .form-group textarea { min-height: 80px; }
        .form-actions { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: flex-end; }
        .form-actions .btn { flex-grow: 0; }
        .hidden { display: none; }
        .link-style { color: var(--blue); cursor: pointer; text-decoration: underline; font-size: 0.9rem; margin-top: 0.5rem; display: inline-block;}
        
        /* --- Table Styles --- */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); font-family: var(--font-secondary); vertical-align: middle;}
        th { font-family: var(--font-primary); font-weight: 600; color: var(--text-light); }
        .status-paid { color: var(--success); font-weight: 600; }
        .status-pending { color: var(--gold); font-weight: 600; }

        .table-actions { display: flex; gap: 0.5rem; justify-content: flex-start; }
        .table-actions button { background: none; border: none; cursor: pointer; padding: 0.25rem; color: var(--text-light); }
        .table-actions button:hover { color: var(--pink); }
        .table-actions .history-client-btn:hover { color: var(--blue); }
        .table-actions svg { width: 20px; height: 20px; }
        .table-actions .whatsapp-icon:hover { color: var(--success); }
        
        /* --- Modal (Pop-up) Styles --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow-y: auto; background-color: rgba(0,0,0,0.6); 
            align-items: flex-start; justify-content: center;
            padding: 2rem 0;
        }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        .modal-content {
            background-color: var(--white); padding: 2rem; border-radius: 0.75rem;
            width: 90%; 
            position: relative;
            animation: slideIn 0.3s ease-out;
            margin: 0;
        }
        #add-edit-product-modal .modal-content, #stock-variation-modal .modal-content, #client-history-modal .modal-content, #sale-receipt-modal .modal-content { max-width: 900px; }
        #add-expense-modal .modal-content, #add-edit-client-modal .modal-content, #add-transaction-modal .modal-content, #notification-modal .modal-content { max-width: 600px; }

        @media (max-width: 767px) {
            #add-edit-product-modal .modal-content { max-width: 90%; }
        }
        
        @keyframes slideIn { from { transform: translateY(-30px); } to { transform: translateY(0); } }
        .modal-close {
            position: absolute; top: 1rem; right: 1rem; background: none; border: none;
            font-size: 1.5rem; cursor: pointer; color: var(--text-light);
        }
        .product-list .product-item {
            display: flex; justify-content: space-between; align-items: center; padding: 1rem;
            border: 1px solid var(--border-color); border-radius: 0.5rem; margin-bottom: 1rem; cursor: pointer;
            transition: background-color 0.2s;
        }
        .product-list .product-item:hover { background-color: var(--pink-light); }
        
        /* --- Toast & Notification Styles --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast {
            background-color: var(--text-dark); color: var(--white); padding: 1rem 1.5rem;
            border-radius: 0.5rem; margin-top: 1rem; font-family: var(--font-primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0;
            transform: translateY(20px); animation: toastIn 0.5s forwards;
        }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
        #notification-list { list-style: none; padding-left: 0; }
        #notification-list li { background-color: var(--pink-light); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; color: var(--pink); border-left: 4px solid var(--pink); }
        #notification-list li strong { font-family: var(--font-primary); }

        /* --- Vendas Page Styles --- */
        .sale-summary-card { position: sticky; top: 1.5rem; }
        .summary-line { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 1rem; }
        .summary-line.total { font-family: var(--font-primary); font-weight: 700; font-size: 1.5rem; color: var(--pink); border-top: 2px dashed var(--border-color); padding-top: 1rem; margin-top: 1rem; }
        .selected-product-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .selected-product-item button { color: #ef4444; background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        #discount-type-group { display: flex; align-items: center; gap: 0.5rem; }
        #discount-type-group select { width: auto; }
        
        /* --- Product Page Styles --- */
        .product-card-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
        .product-card {
            background: var(--white); border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden; display: flex; flex-direction: column;
        }
        .product-card-image {
            height: 180px; background-color: var(--border-color);
            display: flex; align-items: center; justify-content: center; color: var(--text-light);
        }
        .product-card-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-card-content { padding: 1rem; flex-grow: 1; position: relative; }
        .product-card-name { font-family: var(--font-primary); font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 1rem; padding-right: 60px; }
        
        .product-card-actions {
            position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem;
        }
        .product-card-actions button {
            background: none; border: none; cursor: pointer; padding: 0.25rem; color: var(--text-light);
        }
        .product-card-actions button:hover { color: var(--pink); }
        .product-card-actions svg { width: 20px; height: 20px; }

        .product-card-details {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;
            font-size: 0.875rem;
        }
        .product-card-details > div {
            background-color: var(--background); padding: 0.5rem; border-radius: 0.25rem;
        }
        .product-card-details .detail-label {
            display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;
        }
        .product-card-details .detail-value {
            font-weight: 700; color: var(--text-dark);
        }
        .product-card-price {
            grid-column: span 2; background-color: var(--pink-light) !important; text-align: center;
        }
        .product-card-price .detail-value {
            color: var(--pink); font-size: 1.25rem; font-family: var(--font-primary);
        }


        /* --- Despesas Page Styles --- */
        .info-text {
            font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;
            line-height: 1.5;
        }
        .expense-list { list-style: none; padding: 0; }
        .expense-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .expense-item:first-of-type { padding-top: 0; }
        .expense-item:last-child { border-bottom: none; }
        .expense-item span { font-size: 1rem; }
        .expense-item strong { font-family: var(--font-primary); }
        .expense-item .details { font-size: 0.8rem; color: var(--text-light); }
        .expense-category-tag {
            background-color: var(--blue); color: var(--white);
            font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 999px;
            margin-left: 0.5rem; font-family: var(--font-primary);
        }
        
        .calculator-card { background: var(--pink-light); }
        .calculator-result {
            font-family: var(--font-primary);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--pink);
            text-align: center;
            margin-top: 1rem;
        }

        /* --- Add Product Modal Styles --- */
        .fieldset {
            border: 1px solid var(--border-color); border-radius: 0.5rem;
            padding: 1rem; margin-bottom: 1.5rem;
        }
        .fieldset legend {
            padding: 0 0.5rem; font-family: var(--font-primary); font-weight: 600;
            color: var(--text-dark);
        }
        .radio-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .radio-group label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem; }
        
        .pricing-calculator-section { background: var(--background); padding: 1.5rem; border-radius: 0.5rem; }
        .pricing-slider-container { margin: 1.5rem 0; }
        .pricing-slider-container input[type="range"] { width: 100%; cursor: pointer; }
        .pricing-result-card {
            background-image: linear-gradient(to right, var(--pink), var(--gold)); color: var(--white);
            padding: 1.5rem; border-radius: 0.75rem; text-align: center;
        }
        .pricing-result-card .result-label { font-size: 1rem; opacity: 0.9; }
        .pricing-result-card .result-value { font-family: var(--font-primary); font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0; }
        .pricing-result-card .result-details { display: flex; justify-content: space-around; margin-top: 1rem; }
        
        .other-costs-container .dynamic-field { display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem; }
        .other-costs-container .dynamic-field input { flex-grow: 1; }
        
        #stock-variation-modal .modal-content { max-width: 600px; }
        #stock-variation-modal table { width: 100%; }
        #stock-variation-modal th, #stock-variation-modal td { padding: 0.75rem; }
        #stock-variation-modal input { width: 100%; padding: 0.5rem; }

        .modal-form-grid {
            display: grid; grid-template-columns: 1fr; gap: 2rem;
        }
        @media (min-width: 768px) {
            .modal-form-grid { grid-template-columns: 1fr 1fr; }
        }

        .image-preview-container {
            width: 100%; height: 150px; background-color: var(--background);
            border: 2px dashed var(--border-color); border-radius: 0.5rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; margin-bottom: 1rem;
        }
        .image-preview-container img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview-container span { color: var(--text-light); }

        /* --- Utility --- */
        .mb-4 { margin-bottom: 1.5rem; }
        .mt-4 { margin-top: 1.5rem; }
        .text-center { text-align: center; }
        hr { border: none; border-top: 1px solid var(--border-color); margin: 2rem 0; }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- ### SIDEBAR ### -->
        <nav id="sidebar">
            <div>
                <h2 class="sidebar-header">Lucro Certo</h2>
                <ul class="sidebar-nav">
                    <li><a href="#dashboard" class="nav-link active">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" /></svg>
                        <span>Dashboard</span>
                    </a></li>
                    <li><a href="#vendas" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l.383-1.437M7.5 14.25L5.106 5.165A2.25 2.25 0 0 0 2.894 3.75H2.25" /></svg>
                        <span>Vendas</span>
                    </a></li>
                    <li><a href="#produtos" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" /></svg>
                        <span>Produtos</span>
                    </a></li>
                    <li><a href="#precificar" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.826-1.106-2.251 0-3.078s2.76-1.226 4.003-.659c.345.259.69.608.998 1.024v-2.253" /></svg>
                        <span>Precificar</span>
                    </a></li>
                    <li><a href="#despesas" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" /></svg>
                        <span>Despesas</span>
                    </a></li>
                    <li><a href="#financeiro" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V6.375c0-.621.504-1.125 1.125-1.125h.375m16.5 0h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375" /></svg>
                        <span>Financeiro</span>
                    </a></li>
                    <li><a href="#crm" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                        <span>CRM</span>
                    </a></li>
                </ul>
            </div>
            <div class="sidebar-footer">
                 <ul class="sidebar-nav">
                     <li><a href="#perfil" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.227a48.11 48.11 0 0 1 3.076 0c.55.22 1.02.685 1.11 1.227l.588 3.528a2.25 2.25 0 0 0 2.223 1.884h3.528c.542 0 1.007.368 1.227.877a48.097 48.097 0 0 1 0 3.076c-.22.51-.685 1.02-1.227 1.11l-3.528.588a2.25 2.25 0 0 0-1.884 2.223v3.528c0 .542-.368 1.007-.877 1.227a48.097 48.097 0 0 1-3.076 0c-.51-.22-1.02-.685-1.11-1.227l-.588-3.528a2.25 2.25 0 0 0-2.223-1.884h-3.528c-.542 0-1.007-.368-1.227-.877a48.097 48.097 0 0 1 0-3.076c.22-.51.685 1.02 1.227-1.11l3.528-.588a2.25 2.25 0 0 0 1.884-2.223l.588-3.528Z" /></svg>
                        <span>Perfil</span>
                    </a></li>
                      <li><a href="#logout" class="nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" /></svg>
                        <span>Sair</span>
                    </a></li>
                 </ul>
            </div>
        </nav>
        
        <div id="sidebar-overlay"></div>

        <div id="main-content">
            <header class="header">
                 <button class="menu-toggle" aria-label="Abrir menu">☰</button>
                 <h1 id="page-main-title" class="header-title">Olá, Maria!</h1>
            </header>

            <!-- ### DASHBOARD PAGE (UNCHANGED) ### -->
            <section id="dashboard-page" class="page active">
                 <div class="cards-grid quick-actions-grid mb-4">
                     <a href="#vendas" class="quick-action-btn nav-link"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> <span>Nova Venda</span> </a>
                     <a href="#produtos" class="quick-action-btn nav-link"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" /></svg> <span>Meus Produtos</span> </a>
                     <a href="#precificar" class="quick-action-btn nav-link"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.826-1.106-2.251 0-3.078s2.76-1.226 4.003-.659c.345.259.69.608.998 1.024v-2.253" /></svg> <span>Precificar</span> </a>
                     <a href="#financeiro" class="quick-action-btn nav-link"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" /></svg> <span>Financeiro</span> </a>
                </div>
                <div class="cards-grid summary-grid mb-4">
                    <div class="card"> <h3 class="card-title">Faturamento do Mês</h3> <p class="card-value">R$ 7.850,00</p> </div>
                    <div class="card"> <h3 class="card-title">Lucro Estimado</h3> <p class="card-value">R$ 3.140,00</p> </div>
                    <div class="card"> <h3 class="card-title">Despesas do Mês</h3> <p class="card-value">R$ 1.230,00</p> </div>
                    <div class="card"> <h3 class="card-title">Peças em Estoque</h3> <p class="card-value">128</p> </div>
                </div>
                <div class="card mb-4">
                    <h3 class="card-title">Ponto de Equilíbrio</h3> <p class="card-value card-value-small">R$ 4.500,00</p>
                    <div class="progress-bar-container" style="width: 100%; background-color: var(--border-color); border-radius: 999px; height: 10px; margin-top: 1rem; overflow: hidden;"> <div class="progress-bar" style="height: 100%; border-radius: 999px; transition: width 0.5s ease-in-out; background-color: var(--success); width: 85%;"></div> </div>
                    <div class="progress-labels" style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-light);"> <span>Atingido</span> <span>Meta</span> </div>
                </div>
                <div class="cards-grid two-cols">
                    <div class="card"> <h3 class="card-title text-center mb-4">Meta de Faturamento Mensal</h3> <canvas id="goalChart"></canvas> </div>
                    <div class="card"> <h3 class="card-title text-center mb-4">Produtos Mais Vendidos</h3> <canvas id="topProductsChart"></canvas> </div>
                    <div class="card"> <h3 class="card-title text-center mb-4">Top Produtos por Lucro</h3> <canvas id="topProfitChart"></canvas> </div>
                    <div class="card"> <h3 class="card-title text-center mb-4">Distribuição de Custos</h3> <canvas id="costsChart"></canvas> </div>
                </div>
            </section>
            
            <!-- ### VENDAS PAGE (UNCHANGED) ### -->
            <section id="vendas-page" class="page">
                <div class="page-header"> <h2 class="page-title">Ponto de Venda (PDV)</h2> </div>

                <div class="cards-grid vendas-grid">
                    <div id="pdv-form-container" class="card">
                        <form id="sale-form">
                            <div class="form-group">
                                <label for="customer-search">Cliente</label>
                                <input type="search" id="customer-search" placeholder="Buscar cliente ou cadastrar um novo">
                                <button type="button" id="show-customer-form-btn" class="btn btn-secondary mt-4">Cadastrar Novo Cliente</button>
                            </div>
                            <div id="new-customer-form" class="hidden card" style="background-color: var(--pink-light); margin-bottom: 1rem;">
                                 <h3 class="card-title" style="color: var(--pink);">Cadastro Rápido de Cliente</h3>
                                 <div class="form-group">
                                     <label for="new-customer-name">Nome do Cliente (Obrigatório)</label>
                                     <input type="text" id="new-customer-name" required placeholder="Ex: Joana Silva">
                                 </div>
                                 <div class="form-group">
                                     <label for="new-customer-phone">Telefone do Cliente (Obrigatório)</label>
                                     <input type="tel" id="new-customer-phone" required placeholder="(XX) 99999-9999">
                                 </div>
                                 <span id="advanced-customer-toggle" class="link-style">Cadastro Avançado (Opcional)</span>
                                 <div id="advanced-customer-fields" class="hidden mt-4">
                                    <div class="form-group"> <label for="new-customer-cpf">CPF</label> <input type="text" id="new-customer-cpf" placeholder="000.000.000-00"> </div>
                                    <div class="form-group"> <label for="new-customer-email">E-mail</label> <input type="email" id="new-customer-email" placeholder="email@exemplo.com"> </div>
                                     <div class="form-group"> <label for="new-customer-address">Endereço</label> <input type="text" id="new-customer-address" placeholder="Rua, Número, Bairro..."> </div>
                                 </div>
                                 <button type="button" id="save-customer-btn" class="btn btn-primary mt-4">Salvar Cliente</button>
                            </div>
                             <div class="form-group">
                                <label>Produtos</label>
                                <div id="selected-products-list" style="border: 1px dashed var(--border-color); padding: 1rem; border-radius: .5rem; min-height: 50px;">
                                    <p id="no-products-message" class="text-light">Nenhum produto adicionado.</p>
                                </div>
                                <button type="button" id="add-product-btn" class="btn btn-secondary mt-4">Adicionar Produto</button>
                            </div>

                             <fieldset class="fieldset">
                                <legend>Desconto</legend>
                                <div class="form-group" id="discount-type-group">
                                    <select id="discount-type">
                                        <option value="percentage">%</option>
                                        <option value="fixed">R$</option>
                                    </select>
                                    <input type="number" id="discount-value" placeholder="Aplicar desconto">
                                </div>
                            </fieldset>

                             <div class="form-group">
                                <label for="payment-method">Forma de Pagamento</label>
                                <select id="payment-method">
                                    <option value="pix">Pix</option> <option value="credito">Cartão de Crédito</option> <option value="debito">Cartão de Débito</option> <option value="dinheiro">Dinheiro</option> <option value="carne">Carnê (Fiado)</option>
                                </select>
                            </div>
                            <div id="installments-group" class="form-group hidden">
                                <label for="installments-count">Número de Parcelas</label>
                                <input type="number" id="installments-count" value="1" min="1">
                            </div>
                             <div class="form-group">
                                <label for="sale-observations">Observações (Opcional)</label>
                                <textarea id="sale-observations" placeholder="Ex: Cliente pediu para reservar a peça X..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="sale-summary-card card">
                        <h3 class="card-title">Resumo da Venda</h3>
                        <div class="summary-line">
                            <span>Subtotal</span>
                            <span id="summary-subtotal">R$ 0,00</span>
                        </div>
                        <div class="summary-line">
                            <span>Desconto</span>
                            <span id="summary-discount">R$ 0,00</span>
                        </div>
                        <div class="summary-line total">
                            <span>Total</span>
                            <span id="summary-total">R$ 0,00</span>
                        </div>
                        <div class="form-actions" style="margin-top: 2rem;">
                            <button type="button" id="finish-sale-btn" class="btn btn-primary" style="width:100%">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px; height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                                Finalizar Venda
                            </button>
                        </div>
                    </div>
                </div>
                <div class="page-header mt-4">
                     <h2 class="page-title">Histórico de Vendas</h2>
                </div>
                 <div class="card">
                     <div class="table-wrapper">
                         <table>
                             <thead>
                                 <tr> <th>Cliente</th> <th>Data</th> <th>Valor</th> <th>Status</th> <th>Ações</th> </tr>
                             </thead>
                             <tbody id="sales-history-body">
                                 <tr>
                                     <td>Ana Paula</td> <td>25/06/2025</td> <td>R$ 150,00</td> <td><span class="status-paid">Pago</span></td>
                                     <td>
                                         <div class="table-actions">
                                            <button title="Editar" class="edit-sale-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                            <button title="Excluir" class="delete-sale-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                         </div>
                                     </td>
                                 </tr>
                                 <tr>
                                     <td>Beatriz Costa</td> <td>24/06/2025</td> <td>R$ 89,90</td> <td><span class="status-paid">Pago</span></td>
                                     <td>
                                         <div class="table-actions">
                                            <button title="Editar" class="edit-sale-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                            <button title="Excluir" class="delete-sale-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                         </div>
                                     </td>
                                 </tr>
                                 <tr>
                                     <td>Carla Dias</td> <td>23/06/2025</td> <td>R$ 210,50</td> <td><span class="status-pending">Pendente</span></td>
                                     <td>
                                         <div class="table-actions">
                                            <button title="Editar" class="edit-sale-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                            <button title="Excluir" class="delete-sale-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                         </div>
                                     </td>
                                 </tr>
                             </tbody>
                         </table>
                     </div>
                 </div>
            </section>

            <!-- ### PRODUTOS PAGE (MODIFIED) ### -->
            <section id="produtos-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Meus Produtos</h2>
                    <button id="open-add-product-modal-btn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px; height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        Adicionar Produto
                    </button>
                </div>
                
                <div class="cards-grid dashboard-grid mb-4">
                    <div class="card">
                        <h3 class="card-title">Custo Total do Estoque</h3>
                        <p class="card-value">R$ 4.800,00</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Peças em Estoque</h3>
                        <p class="card-value">57</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Lucro Previsto do Estoque</h3>
                        <p class="card-value">R$ 8.239,30</p>
                    </div>
                </div>

                <div class="cards-grid two-cols mb-4">
                    <div class="info-card">
                        <p>Produto com <strong>MAIOR</strong> estoque: <strong>Vestido Rosa (32 un.)</strong></p>
                    </div>
                     <div class="info-card">
                        <p>Produto com <strong>MENOR</strong> estoque: <strong>Saia Midi (25 un.)</strong></p>
                    </div>
                </div>
                
                <hr/>

                <div id="product-card-container" class="product-card-grid">
                    <!-- Products will be dynamically inserted here by JavaScript -->
                </div>
            </section>
            
            <!-- ### DESPESAS PAGE (UNCHANGED) ### -->
            <section id="despesas-page" class="page">
                 <div class="page-header">
                    <h2 class="page-title">Minhas Despesas</h2>
                </div>

                <div class="cards-grid dashboard-grid mb-4">
                    <div class="card">
                        <h3 class="card-title card-title-small">Custo Fixo Total</h3>
                        <p id="total-fixed-cost-display" class="card-value">R$ 0,00</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title card-title-small">Custo Variável Unit. Total</h3>
                        <p id="total-variable-cost-display" class="card-value">R$ 0,00</p>
                    </div>
                     <div class="card calculator-card">
                        <h3 class="card-title card-title-small">Custo Total Unitário</h3>
                        <p id="total-unit-cost-display-top" class="card-value">R$ 0,00</p>
                    </div>
                </div>

                <div class="cards-grid two-cols">
                    <div class="card">
                        <div class="page-header" style="margin-bottom: 0.5rem;">
                             <h3 class="card-title" style="margin-bottom: 0;">Custos Fixos</h3>
                             <button class="btn btn-secondary" id="add-fixed-expense-btn">Adicionar</button>
                        </div>
                        <p class="info-text">Gastos que não mudam com o volume de vendas. Ex: Aluguel, internet, salários.</p>
                        <ul id="fixed-expense-list" class="expense-list">
                            <li class="expense-item" data-value="800.00" data-category="Aluguel">
                                <div>
                                    <span>Aluguel</span>
                                    <div class="details">Vence em: 10/07/2025 (Mensal)<span class="expense-category-tag">Aluguel</span></div>
                                </div>
                                <strong>R$ 800,00</strong>
                            </li>
                            <li class="expense-item" data-value="99.90" data-category="Outros">
                                <div>
                                    <span>Internet</span>
                                     <div class="details">Vence em: 15/07/2025 (Mensal)<span class="expense-category-tag">Outros</span></div>
                                </div>
                                <strong>R$ 99,90</strong>
                            </li>
                        </ul>
                    </div>
                    <div class="card">
                        <div class="page-header" style="margin-bottom: 0.5rem;">
                            <h3 class="card-title" style="margin-bottom: 0;">Custos Variáveis Unitários</h3>
                            <button class="btn btn-secondary" id="add-variable-expense-btn">Adicionar</button>
                        </div>
                        <p class="info-text">Gastos por cada produto vendido. Ex: Embalagem, mimos, taxa do cartão.</p>
                         <ul id="variable-expense-list" class="expense-list">
                            <li class="expense-item" data-value="1.00" data-category="Embalagens">
                                <div>
                                    <span>Embalagem por produto</span>
                                    <span class="expense-category-tag" style="background-color: var(--gold);">Embalagens</span>
                                </div>
                                <strong>R$ 1,00</strong>
                            </li>
                             <li class="expense-item" data-value="2.00" data-category="Marketing">
                                <div>
                                    <span>Mimo por produto</span>
                                    <span class="expense-category-tag" style="background-color: var(--pink);">Marketing</span>
                                </div>
                                <strong>R$ 2,00</strong>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="card mt-4">
                    <h3 class="card-title text-center">Dados para Cálculo do Custo Unitário</h3>
                    <div class="cards-grid two-cols">
                         <div class="form-group">
                            <label for="monthly-shipping-cost">Custo de Frete (Mensal)</label>
                            <input type="number" id="monthly-shipping-cost" placeholder="Ex: 150.00" value="150.00">
                        </div>
                        <div class="form-group">
                            <label for="items-sold-monthly">Peças Vendidas no Mês</label>
                            <input type="number" id="items-sold-monthly" placeholder="Ex: 100" value="100">
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ### FINANCEIRO PAGE (UNCHANGED) ### -->
            <section id="financeiro-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Controle Financeiro</h2>
                    <div class="form-actions">
                         <div class="form-group" style="margin-bottom: 0;">
                             <select id="finance-period-filter">
                                 <option value="monthly">Este Mês</option>
                                 <option value="weekly">Esta Semana</option>
                                 <option value="daily">Hoje</option>
                             </select>
                         </div>
                         <button id="export-report-btn" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px; height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            Exportar Relatório
                        </button>
                         <button id="add-manual-transaction-btn" class="btn btn-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px; height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                             Lançamento Manual
                         </button>
                    </div>
                </div>

                <div class="cards-grid summary-grid mb-4">
                    <div class="card">
                        <h3 class="card-title card-title-small">Contas a Receber</h3>
                        <p class="card-value" style="color: var(--blue);">R$ 210,50</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title card-title-small">Contas a Pagar</h3>
                        <p class="card-value" style="color: #ef4444;">R$ 899,90</p>
                    </div>
                     <div class="card">
                        <h3 class="card-title card-title-small">Balanço do Mês</h3>
                        <p class="card-value" style="color: var(--success);">R$ 6.720,10</p>
                    </div>
                    <div class="card" style="background-color: var(--pink-light)">
                        <h3 class="card-title card-title-small">Saldo Previsto</h3>
                        <p class="card-value" style="color: var(--pink);">R$ 6.030,70</p>
                    </div>
                </div>
                
                <div class="cards-grid two-cols mb-4">
                    <div class="card">
                        <h3 class="card-title text-center">Fluxo de Caixa (Entradas vs. Saídas)</h3>
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="card-title text-center">Despesas por Categoria</h3>
                        <canvas id="expensesByCategoryChart"></canvas>
                    </div>
                </div>
                
                <div class="cards-grid two-cols">
                    <div class="card">
                        <h3 class="card-title">Contas a Receber</h3>
                        <div class="table-wrapper">
                            <table id="receivables-table">
                                <thead>
                                    <tr><th>Cliente</th><th>Vencimento</th><th>Valor</th><th>Ação</th></tr>
                                </thead>
                                <tbody>
                                    <tr data-due-date="2025-06-25">
                                        <td>Carla Dias</td>
                                        <td>25/06/2025</td>
                                        <td>R$ 210,50</td>
                                        <td><button class="btn btn-success btn-sm action-btn">Recebido</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                     <div class="card">
                        <h3 class="card-title">Contas a Pagar</h3>
                         <div class="table-wrapper">
                            <table id="payables-table">
                                <thead>
                                    <tr><th>Descrição</th><th>Vencimento</th><th>Valor</th><th>Ação</th></tr>
                                </thead>
                                <tbody>
                                    <tr data-due-date="2025-07-10">
                                        <td>Aluguel</td>
                                        <td>10/07/2025</td>
                                        <td>R$ 800,00</td>
                                        <td><button class="btn btn-primary btn-sm action-btn">Pagar</button></td>
                                    </tr>
                                    <tr data-due-date="2025-07-15">
                                        <td>Internet</td>
                                        <td>15/07/2025</td>
                                        <td>R$ 99,90</td>
                                        <td><button class="btn btn-primary btn-sm action-btn">Pagar</button></td>
                                    </tr>
                                    <tr data-due-date="2025-06-25">
                                        <td>Fornecedor de Roupas</td>
                                        <td>25/06/2025</td>
                                        <td>R$ 1.250,00</td>
                                        <td><button class="btn btn-primary btn-sm action-btn">Pagar</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </section>
            
            <!-- ### CRM PAGE (UNCHANGED) ### -->
            <section id="crm-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Gestão de Clientes (CRM)</h2>
                    <div class="form-actions">
                        <button class="btn btn-secondary">Importar Lista</button>
                        <button id="add-client-btn" class="btn btn-primary">Adicionar Cliente</button>
                    </div>
                </div>

                <div class="cards-grid summary-grid mb-4">
                    <div class="card">
                        <h3 class="card-title card-title-small">Total de Clientes</h3>
                        <p class="card-value">152</p>
                    </div>
                    <div class="card">
                        <h3 class="card-title card-title-small">Aniversariantes do Mês</h3>
                        <p class="card-value">8</p>
                    </div>
                     <div class="card">
                        <h3 class="card-title card-title-small">Clientes Inativos (+3 meses)</h3>
                        <p class="card-value">12</p>
                    </div>
                    <div class="card" style="background-image: linear-gradient(to right, var(--gold-light), var(--gold));">
                        <h3 class="card-title card-title-small" style="color: var(--text-dark);">Cliente Campeão</h3>
                        <p class="card-value-small" style="font-size: 1.2rem; font-weight: 700;">Ana Paula</p>
                        <p class="card-value" style="font-size: 1.5rem; color: var(--text-dark);">R$ 1.850,00</p>
                    </div>
                </div>

                 <div class="card">
                     <div class="table-wrapper">
                         <table>
                             <thead>
                                 <tr> 
                                     <th>Nome</th> 
                                     <th>Contato</th> 
                                     <th>Última Compra</th> 
                                     <th>Total Gasto</th> 
                                     <th>Ticket Médio</th> 
                                     <th>Ações</th> 
                                </tr>
                             </thead>
                             <tbody id="client-list-body">
                                 <tr data-id="1" data-name="Ana Paula" data-phone="(62) 99999-8888" data-email="ana.paula@exemplo.com" data-address="Rua das Flores, 123" data-birthdate="1990-07-15">
                                     <td>Ana Paula</td> 
                                     <td>(62) 99999-8888</td> 
                                     <td>25/06/2025</td>
                                     <td>R$ 1.850,00</td>
                                     <td>R$ 462,50</td>
                                     <td>
                                         <div class="table-actions">
                                            <button title="Histórico" class="history-client-btn">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                                            </button>
                                            <button title="Enviar WhatsApp" class="whatsapp-icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c.966 0 1.896-.156 2.748-.435l4.106 1.026-1.026-4.105A9.002 9.002 0 0 0 21 12c0-4.968-4.032-9-9-9s-9 4.032-9 9c0 2.492 1.009 4.742 2.636 6.364L3 21l4.105-1.026A8.932 8.932 0 0 0 12 20.25Z" /></svg>
                                            </button>
                                            <button title="Editar" class="edit-client-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                            <button title="Excluir" class="delete-client-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                         </div>
                                     </td>
                                 </tr>
                                 <tr data-id="2" data-name="Beatriz Costa" data-phone="(62) 98888-7777" data-email="bia.costa@exemplo.com" data-address="" data-birthdate="1995-02-20">
                                     <td>Beatriz Costa</td>
                                     <td>(62) 98888-7777</td>
                                     <td>24/06/2025</td>
                                     <td>R$ 980,70</td>
                                     <td>R$ 163,45</td>
                                     <td>
                                         <div class="table-actions">
                                            <button title="Histórico" class="history-client-btn">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                                            </button>
                                            <button title="Enviar WhatsApp" class="whatsapp-icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c.966 0 1.896-.156 2.748-.435l4.106 1.026-1.026-4.105A9.002 9.002 0 0 0 21 12c0-4.968-4.032-9-9-9s-9 4.032-9 9c0 2.492 1.009 4.742 2.636 6.364L3 21l4.105-1.026A8.932 8.932 0 0 0 12 20.25Z" /></svg>
                                            </button>
                                            <button title="Editar" class="edit-client-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                            <button title="Excluir" class="delete-client-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                         </div>
                                     </td>
                                 </tr>
                             </tbody>
                         </table>
                     </div>
                 </div>
            </section>
        </div>
    </div>
    
    <div id="toast-container"></div>
    
    <div id="vendas-product-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="page-title mb-4">Adicionar Produto à Venda</h3>
            <div class="product-list">
                <div class="product-item" data-name="Vestido Rosa" data-price="150.00" data-stock="5" data-variations='[{"name":"P", "stock":2}, {"name":"M", "stock":3}]'> <span>Vestido Rosa <small>(Estoque: 5)</small></span> <strong>R$ 150,00</strong> </div>
                <div class="product-item" data-name="Saia Midi" data-price="89.90" data-stock="8"> <span>Saia Midi <small>(Estoque: 8)</small></span> <strong>R$ 89,90</strong> </div>
                <div class="product-item" data-name="Calça Jeans" data-price="210.50" data-stock="3"> <span>Calça Jeans <small>(Estoque: 3)</small></span> <strong>R$ 210,50</strong> </div>
            </div>
        </div>
    </div>

    <!-- ### VARIATION SELECTION MODAL (NEW) ### -->
    <div id="vendas-variation-modal" class="modal">
         <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="variation-modal-title" class="page-title mb-4">Selecionar Variação</h3>
            <div id="variation-list" class="product-list">
                <!-- Variation items will be inserted here by JS -->
            </div>
        </div>
    </div>

    <!-- ### ADD/EDIT PRODUCT MODAL (MODIFIED) ### -->
    <div id="add-edit-product-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="product-modal-title" class="page-title mb-4">Adicionar Novo Produto</h3>
            <form id="new-product-form">
                <div class="modal-form-grid">
                    <!-- Coluna da Esquerda: Dados do Produto -->
                    <div>
                        <div class="form-group">
                            <label for="product-image-input">Imagem do Produto</label>
                            <label for="product-image-input" class="image-preview-container" id="image-preview-container">
                                <img id="image-preview" src="" alt="Pré-visualização da imagem" class="hidden">
                                <span id="image-preview-text">Clique para enviar uma imagem</span>
                            </label>
                            <input type="file" id="product-image-input" accept="image/*" class="hidden">
                        </div>
                        <div class="form-group">
                            <label for="product-name">Nome do Produto</label>
                            <input type="text" id="product-name" required placeholder="Ex: Vestido Floral">
                        </div>
                        <div class="form-group">
                            <label for="product-acquisition-cost">Custo de Aquisição do Produto (R$)</label>
                            <input type="number" id="product-acquisition-cost" step="0.01" required placeholder="Valor pago pelo produto">
                        </div>
                        <fieldset class="fieldset">
                            <legend>Variações e Estoque</legend>
                            <div class="radio-group" id="variation-type-group">
                                <label><input type="radio" name="variationType" value="none" checked> Sem Variação</label>
                                <label><input type="radio" name="variationType" value="simple"> Variação Simples</label>
                                <label><input type="radio" name="variationType" value="combined"> Variação Combinada</label>
                            </div>

                            <div id="no-variation-section" class="mt-4">
                                <div class="form-group">
                                    <label for="single-product-stock">Estoque</label>
                                    <input type="number" id="single-product-stock" placeholder="0">
                                </div>
                            </div>
                            
                            <div id="simple-variation-section" class="hidden mt-4">
                                <div class="cards-grid two-cols">
                                    <div class="form-group"> <label for="simple-variation-name">Nome da Variação</label> <input type="text" id="simple-variation-name" placeholder="Ex: Tamanho"> </div>
                                    <div class="form-group"> <label for="simple-variation-values">Valores (por vírgula)</label> <input type="text" id="simple-variation-values" placeholder="Ex: P, M, G"> </div>
                                </div>
                                <button type="button" id="generate-simple-stock-btn" class="btn btn-secondary">Lançar Estoque</button>
                            </div>

                            <div id="combined-variation-section" class="hidden mt-4">
                                <p class="info-text" style="font-size: 0.8rem;">Crie combinações como Cor + Tamanho.</p>
                                <div class="form-group"> <label for="combined-variation-name-1">Nome da Variação 1</label> <input type="text" id="combined-variation-name-1" placeholder="Ex: Cor"> </div>
                                <div class="form-group"> <label for="combined-variation-values-1">Valores da Variação 1 (por vírgula)</label> <input type="text" id="combined-variation-values-1" placeholder="Ex: Preto, Branco"> </div>
                                <hr style="margin: 1rem 0;">
                                <div class="form-group"> <label for="combined-variation-name-2">Nome da Variação 2</label> <input type="text" id="combined-variation-name-2" placeholder="Ex: Tamanho"> </div>
                                <div class="form-group"> <label for="combined-variation-values-2">Valores da Variação 2 (por vírgula)</label> <input type="text" id="combined-variation-values-2" placeholder="Ex: P, M, G"> </div>
                                <button type="button" id="generate-combined-stock-btn" class="btn btn-secondary">Gerar Combinações e Lançar Estoque</button>
                            </div>
                        </fieldset>
                    </div>
                    <!-- Coluna da Direita: Calculadora -->
                    <div>
                        <h3 class="card-title">Calculadora de Precificação</h3>
                        <div class="pricing-calculator-section">
                            <div class="form-group">
                                <label>Custo Total Unitário (Automático)</label>
                                <input type="text" id="auto-unit-cost" readonly style="background: var(--border-color); font-weight: bold;">
                            </div>
                            <div class="form-group">
                                <label>Outros Custos em % (Ex: Taxa de maquininha)</label>
                                <div id="other-costs-container" class="other-costs-container"></div>
                                <button type="button" id="add-other-cost-btn" class="btn btn-secondary btn-sm mt-4">Adicionar outro custo (%)</button>
                            </div>
                        </div>
                        <div class="pricing-slider-container">
                            <label for="profit-margin-slider" class="form-group">Lucro sobre o Custo</label>
                            <input type="range" id="profit-margin-slider" min="0" max="300" value="100" class="mt-4">
                        </div>
                        <div class="pricing-result-card">
                            <div class="result-label">Preço de Venda Sugerido</div>
                            <div id="suggested-price" class="result-value">R$ 0,00</div>
                            <div class="result-details">
                                <div> <span class="result-label">Lucro (%)</span> <div id="profit-percentage">100%</div> </div>
                                <div> <span class="result-label">Lucro (R$)</span> <div id="profit-value">R$ 0,00</div> </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr />
                <div class="form-actions">
                    <button type="button" id="cancel-product-btn" class="btn btn-danger">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ### STOCK VARIATION MODAL (UNCHANGED) ### -->
    <div id="stock-variation-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="page-title mb-4">Lançar Estoque das Variações</h3>
             <div class="table-wrapper">
                <table>
                    <thead id="variation-table-head">
                        <!-- Header generated by JS -->
                    </thead>
                    <tbody id="variation-stock-body">
                        <!-- Rows will be generated by JS -->
                    </tbody>
                </table>
            </div>
            <button type="button" id="save-stock-btn" class="btn btn-primary mt-4" style="width: 100%;">Salvar Estoque</button>
        </div>
    </div>

    <!-- ### ADD EXPENSE MODAL (UNCHANGED) ### -->
    <div id="add-expense-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="expense-modal-title" class="page-title mb-4">Adicionar Despesa</h3>
            <form id="expense-form">
                <div class="form-group"> <label for="expense-name">Nome da Despesa</label> <input type="text" id="expense-name" required> </div>
                <div class="form-group"> <label for="expense-value">Valor (R$)</label> <input type="number" id="expense-value" step="0.01" required> </div>
                <div class="form-group">
                    <label for="expense-category">Categoria</label>
                    <select id="expense-category">
                        <option value="Fornecedores">Fornecedores</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Aluguel">Aluguel</option>
                        <option value="Embalagens">Embalagens</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div id="fixed-expense-fields">
                     <div class="form-group"> <label for="expense-due-date">Data de Vencimento</label> <input type="date" id="expense-due-date"> </div>
                     <div class="form-group"> <label for="expense-recurrence">Recorrência</label> <select id="expense-recurrence"> <option value="Mensal">Mensal</option> <option value="Parcelado">Parcelado</option> <option value="Única">Pagamento Único</option> </select> </div>
                </div>
                <input type="hidden" id="expense-type-hidden">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Salvar Despesa</button>
            </form>
        </div>
    </div>

    <!-- ### ADD/EDIT CLIENT MODAL (UNCHANGED) ### -->
    <div id="add-edit-client-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="client-modal-title" class="page-title mb-4">Adicionar Novo Cliente</h3>
            <form id="new-client-form">
                <input type="hidden" id="client-id">
                <div class="form-group"> <label for="client-name">Nome</label> <input type="text" id="client-name" required> </div>
                <div class="form-group"> <label for="client-phone">Telefone</label> <input type="tel" id="client-phone"> </div>
                <div class="form-group"> <label for="client-email">E-mail</label> <input type="email" id="client-email"> </div>
                <div class="form-group"> <label for="client-address">Endereço</label> <input type="text" id="client-address"> </div>
                <div class="form-group"> <label for="client-birthdate">Data de Nascimento</label> <input type="date" id="client-birthdate"> </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger modal-close">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ### CLIENT HISTORY MODAL (UNCHANGED) ### -->
    <div id="client-history-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="client-history-modal-title" class="page-title mb-4">Histórico de Compras</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Itens Comprados</th>
                            <th>Valor Total</th>
                        </tr>
                    </thead>
                    <tbody id="client-history-list">
                        <!-- History items will be inserted here by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- ### MANUAL TRANSACTION MODAL (UNCHANGED) ### -->
    <div id="add-transaction-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="page-title mb-4">Adicionar Lançamento Manual</h3>
            <form id="transaction-form">
                <div class="form-group">
                    <label for="transaction-description">Descrição</label>
                    <input type="text" id="transaction-description" required>
                </div>
                <div class="form-group">
                    <label for="transaction-value">Valor (R$)</label>
                    <input type="number" id="transaction-value" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="transaction-type">Tipo de Lançamento</label>
                    <select id="transaction-type">
                        <option value="entrada">Entrada</option>
                        <option value="saida">Saída</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transaction-date">Data</label>
                    <input type="date" id="transaction-date" required>
                </div>
                 <button type="submit" class="btn btn-primary" style="width: 100%;">Salvar Lançamento</button>
            </form>
        </div>
    </div>
    
    <!-- ### NOTIFICATION MODAL (UNCHANGED) ### -->
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="page-title mb-4">Lembretes e Avisos</h3>
            <ul id="notification-list">
                <!-- Notifications will be inserted here by JS -->
            </ul>
        </div>
    </div>

    <!-- ### SALE RECEIPT MODAL (UNCHANGED) ### -->
    <div id="sale-receipt-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="page-title mb-4">Recibo da Venda</h3>
            <div id="receipt-content">
                <p><strong>Cliente:</strong> <span id="receipt-client-name"></span></p>
                <p><strong>Data:</strong> <span id="receipt-date"></span></p>
                <hr style="margin: 1rem 0;">
                <h4>Produtos:</h4>
                <ul id="receipt-product-list" style="list-style: none; padding: 0.5rem 0;"></ul>
                <hr style="margin: 1rem 0;">
                <div class="summary-line"><span>Subtotal:</span> <span id="receipt-subtotal"></span></div>
                <div class="summary-line"><span>Desconto:</span> <span id="receipt-discount"></span></div>
                <div class="summary-line total"><span>Total:</span> <span id="receipt-total"></span></div>
            </div>
             <div class="form-actions mt-4">
                <button class="btn btn-secondary">Imprimir Recibo</button>
                <button class="btn btn-whatsapp">Enviar por WhatsApp</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global Elements ---
            const menuToggle = document.querySelector('.menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const navLinks = document.querySelectorAll('.nav-link');
            const pageTitle = document.getElementById('page-main-title');
            let productStockData = {}; 
            let isExpensePageInitialized = false;
            let areSalesActionsInitialized = false;
            let areProductActionsInitialized = false;
            let isCrmPageInitialized = false;
            let isFinanceiroPageInitialized = false; 
            let currentSaleItems = [];
            let productForVariationSelection = null;

            // --- Utility Functions ---
            const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;
            const parseCurrency = (value) => parseFloat(String(value).replace('R$ ', '').replace('.', '').replace(',', '.'));

            // --- Toast Notification Function ---
            const showToast = (message) => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 3000);
            };

            // --- Menu Logic ---
            const closeMenu = () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            };
            const openMenu = () => {
                sidebar.classList.add('active');
                overlay.classList.add('active');
            };
            menuToggle.addEventListener('click', openMenu);
            overlay.addEventListener('click', closeMenu);

             // --- Global Data/State Management ---
            const addClientToCrmTable = (clientData) => {
                const clientListBody = document.getElementById('client-list-body');
                if (!clientListBody) return;
                const newRow = document.createElement('tr');
                newRow.dataset.id = clientData.id || Date.now();
                newRow.dataset.name = clientData.name || '';
                newRow.dataset.phone = clientData.phone || '';
                newRow.dataset.email = clientData.email || '';
                newRow.dataset.address = clientData.address || '';
                newRow.dataset.birthdate = clientData.birthdate || '';
                newRow.innerHTML = `
                    <td>${clientData.name}</td><td>${clientData.phone}</td><td>-</td><td>R$ 0,00</td><td>R$ 0,00</td>
                    <td>
                        <div class="table-actions">
                            <button title="Histórico" class="history-client-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg></button>
                            <button title="Enviar WhatsApp" class="whatsapp-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c.966 0 1.896-.156 2.748-.435l4.106 1.026-1.026-4.105A9.002 9.002 0 0 0 21 12c0-4.968-4.032-9-9-9s-9 4.032-9 9c0 2.492 1.009 4.742 2.636 6.364L3 21l4.105-1.026A8.932 8.932 0 0 0 12 20.25Z" /></svg></button>
                            <button title="Editar" class="edit-client-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                            <button title="Excluir" class="delete-client-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                        </div>
                    </td>`;
                clientListBody.prepend(newRow);
            };

            // --- SPA Navigation Logic ---
            const showPage = (pageId, title) => {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) targetPage.classList.add('active');
                
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === `#${pageId.replace('-page', '')}`) {
                        link.classList.add('active');
                    }
                });

                pageTitle.textContent = (pageId === 'dashboard-page') ? "Olá, Maria!" : title;
                closeMenu();

                // Initialize page-specific logic
                if (pageId === 'dashboard-page' && typeof initializeDashboardCharts !== 'undefined') initializeDashboardCharts();
                if (pageId === 'vendas-page' && !areSalesActionsInitialized) {
                    initializeVendasPage();
                    areSalesActionsInitialized = true;
                }
                 if (pageId === 'produtos-page' && !areProductActionsInitialized) {
                    initializeProductCardActions();
                    areProductActionsInitialized = true;
                }
                if (pageId === 'despesas-page' && !isExpensePageInitialized) {
                    initializeExpensesPage();
                    isExpensePageInitialized = true;
                } else if (pageId === 'despesas-page') {
                    if(typeof updateExpenseCalculations !== 'undefined') updateExpenseCalculations();
                }
                if (pageId === 'crm-page' && !isCrmPageInitialized) {
                    initializeCrmPage();
                    isCrmPageInitialized = true;
                }
                if (pageId === 'financeiro-page' && !isFinanceiroPageInitialized) {
                    initializeFinanceiroPage();
                    isFinanceiroPageInitialized = true;
                }
            };

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('href').substring(1) + '-page';
                    const title = link.querySelector('span').textContent;
                    showPage(pageId, title);
                    window.location.hash = link.getAttribute('href');
                });
            });
            
            // --- Notification Logic ---
            const checkDueDatesAndNotify = () => {
                const notificationModal = document.getElementById('notification-modal');
                const notificationList = document.getElementById('notification-list');
                if (!notificationModal || !notificationList) return;
                
                notificationList.innerHTML = ''; // Clear previous notifications
                const notifications = [];
                
                // --- Simulate today's date for demonstration ---
                const today = new Date('2025-06-25T12:00:00'); // Setting time to noon to avoid timezone issues
                today.setHours(0, 0, 0, 0);

                // Check payables
                document.querySelectorAll('#payables-table tbody tr').forEach(row => {
                    const dueDateStr = row.dataset.dueDate;
                    const dueDate = new Date(dueDateStr + 'T12:00:00');
                    dueDate.setHours(0, 0, 0, 0);

                    const description = row.cells[0].textContent;
                    if (dueDate.getTime() === today.getTime()) {
                        notifications.push(`<li><strong>Aviso:</strong> A conta "<strong>${description}</strong>" vence hoje. Você já pagou?</li>`);
                    }
                });
                
                // Check receivables
                document.querySelectorAll('#receivables-table tbody tr').forEach(row => {
                    const dueDateStr = row.dataset.dueDate;
                    const dueDate = new Date(dueDateStr + 'T12:00:00');
                    dueDate.setHours(0, 0, 0, 0);

                    const clientName = row.cells[0].textContent;
                     if (dueDate.getTime() === today.getTime()) {
                        notifications.push(`<li><strong>Lembrete:</strong> Você precisa receber de "<strong>${clientName}</strong>" hoje. Já recebeu?</li>`);
                    }
                });

                if (notifications.length > 0) {
                    notificationList.innerHTML = notifications.join('');
                    notificationModal.classList.add('active');
                }

                notificationModal.querySelector('.modal-close').addEventListener('click', () => {
                    notificationModal.classList.remove('active');
                });
            };

            // --- Page Initializers ---

            // Initial Page Load
            const currentHash = window.location.hash || '#dashboard';
            const initialPageId = currentHash.substring(1) + '-page';
            const initialLink = document.querySelector(`.nav-link[href='${currentHash}']`);
            const initialTitle = initialLink ? initialLink.querySelector('span').textContent : 'Dashboard';
            showPage(initialPageId, initialTitle);
            
            checkDueDatesAndNotify(); // Check for notifications on page load

            // --- Vendas Page Logic (UNCHANGED) ---
            function initializeVendasPage() {
                // ... other Vendas initializers
                const salesHistoryBody = document.getElementById('sales-history-body');
                const showCustomerFormBtn = document.getElementById('show-customer-form-btn');
                const newCustomerForm = document.getElementById('new-customer-form');
                const saveCustomerBtn = document.getElementById('save-customer-btn');
                const customerSearchInput = document.getElementById('customer-search');
                const addProductBtn = document.getElementById('add-product-btn');
                const productModal = document.getElementById('vendas-product-modal');
                const productModalCloseBtn = productModal.querySelector('.modal-close');
                const selectedProductsList = document.getElementById('selected-products-list');
                const discountValueInput = document.getElementById('discount-value');
                const discountTypeSelect = document.getElementById('discount-type');
                const finishSaleBtn = document.getElementById('finish-sale-btn');
                const receiptModal = document.getElementById('sale-receipt-modal');
                const receiptModalCloseBtn = receiptModal.querySelector('.modal-close');
                const variationModal = document.getElementById('vendas-variation-modal');
                const variationList = document.getElementById('variation-list');
                const variationModalCloseBtn = variationModal.querySelector('.modal-close');
                
                const updateSaleSummary = () => {
                    let subtotal = 0;
                    currentSaleItems.forEach(item => subtotal += item.price);
                    
                    const discountValue = parseFloat(discountValueInput.value) || 0;
                    let discountAmount = 0;
                    if (discountTypeSelect.value === 'percentage') {
                        discountAmount = subtotal * (discountValue / 100);
                    } else {
                        discountAmount = discountValue;
                    }

                    const total = subtotal - discountAmount;
                    
                    document.getElementById('summary-subtotal').textContent = formatCurrency(subtotal);
                    document.getElementById('summary-discount').textContent = `- ${formatCurrency(discountAmount)}`;
                    document.getElementById('summary-total').textContent = formatCurrency(total);
                };
                
                const renderSelectedProducts = () => {
                    if (currentSaleItems.length === 0) {
                        selectedProductsList.innerHTML = '<p id="no-products-message" class="text-light">Nenhum produto adicionado.</p>';
                    } else {
                        selectedProductsList.innerHTML = '';
                        currentSaleItems.forEach((item, index) => {
                            const li = document.createElement('div');
                            li.className = 'selected-product-item';
                            li.innerHTML = `
                                <span>${item.name}</span>
                                <div>
                                    <strong>${formatCurrency(item.price)}</strong>
                                    <button class="remove-product-btn" data-index="${index}">&times;</button>
                                </div>
                            `;
                            selectedProductsList.appendChild(li);
                        });
                    }
                    updateSaleSummary();
                };

                if (addProductBtn) addProductBtn.addEventListener('click', () => productModal.classList.add('active'));
                if (productModalCloseBtn) productModalCloseBtn.addEventListener('click', () => productModal.classList.remove('active'));
                if (variationModalCloseBtn) variationModalCloseBtn.addEventListener('click', () => variationModal.classList.remove('active'));

                productModal.addEventListener('click', e => {
                    const itemElement = e.target.closest('.product-item');
                    if (itemElement) {
                        const variations = itemElement.dataset.variations;
                        productForVariationSelection = {
                            name: itemElement.dataset.name,
                            price: parseFloat(itemElement.dataset.price)
                        };

                        if (variations) {
                            const variationsData = JSON.parse(variations);
                            variationList.innerHTML = '';
                            variationsData.forEach(v => {
                                const variationItem = document.createElement('div');
                                variationItem.className = 'product-item';
                                variationItem.dataset.variationName = v.name;
                                variationItem.innerHTML = `<span>${v.name} <small>(Estoque: ${v.stock})</small></span>`;
                                variationList.appendChild(variationItem);
                            });
                            document.getElementById('variation-modal-title').textContent = `Variações de ${productForVariationSelection.name}`;
                            productModal.classList.remove('active');
                            variationModal.classList.add('active');
                        } else {
                            currentSaleItems.push(productForVariationSelection);
                            renderSelectedProducts();
                            productModal.classList.remove('active');
                        }
                    }
                });

                variationModal.addEventListener('click', e => {
                    const variationElement = e.target.closest('.product-item');
                    if (variationElement) {
                        const variationName = variationElement.dataset.variationName;
                        const finalProduct = {
                            name: `${productForVariationSelection.name} - ${variationName}`,
                            price: productForVariationSelection.price
                        };
                        currentSaleItems.push(finalProduct);
                        renderSelectedProducts();
                        variationModal.classList.remove('active');
                    }
                });
                
                selectedProductsList.addEventListener('click', e => {
                    if (e.target.classList.contains('remove-product-btn')) {
                        const index = parseInt(e.target.dataset.index);
                        currentSaleItems.splice(index, 1);
                        renderSelectedProducts();
                    }
                });

                if (discountValueInput) discountValueInput.addEventListener('input', updateSaleSummary);
                if (discountTypeSelect) discountTypeSelect.addEventListener('change', updateSaleSummary);
                
                if (finishSaleBtn) {
                    finishSaleBtn.addEventListener('click', () => {
                        const clientName = customerSearchInput.value.trim();
                        if (!clientName || currentSaleItems.length === 0) {
                            showToast("Adicione um cliente e pelo menos um produto para finalizar.");
                            return;
                        }

                        // Populate and show receipt modal
                        document.getElementById('receipt-client-name').textContent = clientName;
                        document.getElementById('receipt-date').textContent = new Date().toLocaleDateString('pt-BR');
                        const receiptProductList = document.getElementById('receipt-product-list');
                        receiptProductList.innerHTML = '';
                        currentSaleItems.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.name} - ${formatCurrency(item.price)}`;
                            receiptProductList.appendChild(li);
                        });
                        document.getElementById('receipt-subtotal').textContent = document.getElementById('summary-subtotal').textContent;
                        document.getElementById('receipt-discount').textContent = document.getElementById('summary-discount').textContent;
                        document.getElementById('receipt-total').textContent = document.getElementById('summary-total').textContent;
                        
                        receiptModal.classList.add('active');
                    });
                }
                
                if (receiptModalCloseBtn) receiptModalCloseBtn.addEventListener('click', () => receiptModal.classList.remove('active'));
                
                // Existing logic for customer management
                if (showCustomerFormBtn) {
                    showCustomerFormBtn.addEventListener('click', () => {
                        newCustomerForm.classList.toggle('hidden');
                    });
                }
                if (saveCustomerBtn) {
                    saveCustomerBtn.addEventListener('click', () => {
                        const nameInput = document.getElementById('new-customer-name');
                        const phoneInput = document.getElementById('new-customer-phone');
                        const name = nameInput.value.trim();
                        const phone = phoneInput.value.trim();

                        if (!name || !phone) {
                            showToast("Nome e telefone são obrigatórios.");
                            return;
                        }
                        const email = document.getElementById('new-customer-email').value.trim();
                        const address = document.getElementById('new-customer-address').value.trim();
                        const clientData = { name, phone, email, address };
                        addClientToCrmTable(clientData);
                        showToast(`Cliente "${name}" cadastrado com sucesso!`);
                        customerSearchInput.value = name;
                        newCustomerForm.classList.add('hidden');
                        nameInput.value = '';
                        phoneInput.value = '';
                        document.getElementById('new-customer-email').value = '';
                        document.getElementById('new-customer-address').value = '';
                    });
                }
            }


            // --- Product Page Actions (MODIFIED) ---
            const addEditProductModal = document.getElementById('add-edit-product-modal');
            const productForm = document.getElementById('new-product-form');
            const stockVariationModal = document.getElementById('stock-variation-modal');
            
            function initializeProductCardActions() {
                const productContainer = document.getElementById('product-card-container');
                if(!productContainer) return;
                productContainer.addEventListener('click', (e) => {
                    const targetButton = e.target.closest('button');
                    if (!targetButton) return;
                    const card = targetButton.closest('.product-card');
                    if (!card) return;
                    if (targetButton.classList.contains('delete-product-btn')) {
                        card.remove();
                        showToast('Produto excluído com sucesso!');
                    } else if (targetButton.classList.contains('edit-product-btn')) {
                        openProductModalForEdit(card);
                    } else if (targetButton.classList.contains('restock-product-btn')) {
                        const productName = card.dataset.name;
                        const variationsJSON = card.dataset.variations;
                        
                        stockVariationModal.dataset.updatingCardId = card.id;

                        if (variationsJSON && variationsJSON !== 'null') {
                            const variationsData = JSON.parse(variationsJSON);
                            const headers = Object.keys(variationsData[0]).filter(k => k !== 'stock');
                            const rows = variationsData.map(v => headers.map(h => v[h]));
                            const stockValues = variationsData.map(v => v.stock);
                            openStockModal(headers, rows, stockValues);
                        } else {
                             const currentStock = card.dataset.totalstock || '0';
                             openStockModal(['Produto'], [[productName]], [currentStock]);
                        }
                    }
                });
            }

            const getPriceCalculation = () => {
                if(!productForm) return {};
                const acquisitionCost = parseFloat(productForm.querySelector('#product-acquisition-cost').value) || 0;
                const autoUnitCost = parseCurrency(productForm.querySelector('#auto-unit-cost').value) || 0;
                
                let totalOtherCostsPercent = 0;
                productForm.querySelectorAll('#other-costs-container input').forEach(input => { totalOtherCostsPercent += parseFloat(input.value) || 0; });
                
                const costBaseBeforePercentages = acquisitionCost + autoUnitCost;
                const totalCostBase = totalOtherCostsPercent > 0 ? costBaseBeforePercentages / (1 - (totalOtherCostsPercent / 100)) : costBaseBeforePercentages;
                
                const profitMargin = parseInt(productForm.querySelector('#profit-margin-slider').value);
                const sellingPrice = totalCostBase * (1 + (profitMargin / 100));
                const profitValue = sellingPrice - totalCostBase;
                
                return { totalCostBase, sellingPrice, profitMargin, profitValue, acquisitionCost };
            };
            
            const calculateAndDisplayPrice = () => {
                if(!productForm) return;
                const { sellingPrice, profitMargin, profitValue } = getPriceCalculation();
                productForm.querySelector('#suggested-price').textContent = formatCurrency(sellingPrice);
                productForm.querySelector('#profit-percentage').textContent = `${profitMargin}%`;
                productForm.querySelector('#profit-value').textContent = formatCurrency(profitValue);
            };
            
            if (addEditProductModal) {
                const productModalTitle = document.getElementById('product-modal-title');
                const openBtn = document.getElementById('open-add-product-modal-btn');
                const closeBtn = addEditProductModal.querySelector('.modal-close');
                const cancelBtn = document.getElementById('cancel-product-btn');
                const productGrid = document.getElementById('product-card-container');
                const imageInput = document.getElementById('product-image-input');
                const imagePreview = document.getElementById('image-preview');
                const imagePreviewText = document.getElementById('image-preview-text');
                const acquisitionCostInput = document.getElementById('product-acquisition-cost');
                const profitSlider = document.getElementById('profit-margin-slider');
                const addOtherCostBtn = document.getElementById('add-other-cost-btn');
                const variationTypeGroup = document.getElementById('variation-type-group');
                const stockModalCloseBtn = stockVariationModal.querySelector('.modal-close');
                const saveStockBtn = document.getElementById('save-stock-btn');


                const openProductModal = (isEdit = false, cardToEdit = null) => {
                    productForm.reset();
                    productForm.removeAttribute('data-editing-id');
                    productStockData = {};
                    productForm.querySelector('#other-costs-container').innerHTML = '';
                    imagePreview.classList.add('hidden');
                    imagePreview.src = '';
                    imagePreviewText.classList.remove('hidden');
                    document.querySelector('input[name="variationType"][value="none"]').click();
                    const unitCostValue = document.getElementById('total-unit-cost-display-top').textContent;
                    productForm.querySelector('#auto-unit-cost').value = unitCostValue;

                    if (isEdit && cardToEdit) {
                        productModalTitle.textContent = "Editar Produto";
                        productForm.setAttribute('data-editing-id', cardToEdit.id);
                        productForm.querySelector('#product-name').value = cardToEdit.dataset.name || '';
                        productForm.querySelector('#product-acquisition-cost').value = cardToEdit.dataset.acquisitioncost || 0;
                        productForm.querySelector('#single-product-stock').value = cardToEdit.dataset.totalstock || 0;
                        profitSlider.value = cardToEdit.dataset.profitmargin || 100;
                        if (cardToEdit.dataset.imagesrc && cardToEdit.dataset.imagesrc !== 'null') {
                            imagePreview.src = cardToEdit.dataset.imagesrc;
                            imagePreview.classList.remove('hidden');
                            imagePreviewText.classList.add('hidden');
                        }
                    } else {
                        productModalTitle.textContent = "Adicionar Novo Produto";
                    }
                    addEditProductModal.classList.add('active');
                    calculateAndDisplayPrice();
                };

                const closeProductModal = () => addEditProductModal.classList.remove('active');
                if(openBtn) openBtn.addEventListener('click', () => openProductModal(false));
                if(closeBtn) closeBtn.addEventListener('click', closeProductModal);
                if(cancelBtn) cancelBtn.addEventListener('click', closeProductModal);
                window.openProductModalForEdit = (card) => { openProductModal(true, card); };

                if(imageInput) imageInput.addEventListener('change', function() {
                    const file = this.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { 
                            imagePreview.src = e.target.result;
                            imagePreview.classList.remove('hidden');
                            imagePreviewText.classList.add('hidden');
                         };
                        reader.readAsDataURL(file);
                    }
                });

                if(acquisitionCostInput) acquisitionCostInput.addEventListener('input', calculateAndDisplayPrice);
                if(profitSlider) profitSlider.addEventListener('input', calculateAndDisplayPrice);
                if(addOtherCostBtn) addOtherCostBtn.addEventListener('click', () => {
                    const dynamicField = document.createElement('div');
                    dynamicField.className = 'dynamic-field';
                    dynamicField.innerHTML = `<input type="number" step="0.01" placeholder="Ex: 4.99"><span>%</span>`;
                    dynamicField.querySelector('input').addEventListener('input', calculateAndDisplayPrice);
                    productForm.querySelector('#other-costs-container').appendChild(dynamicField);
                });

                variationTypeGroup.addEventListener('change', (e) => {
                    document.getElementById('no-variation-section').classList.add('hidden');
                    document.getElementById('simple-variation-section').classList.add('hidden');
                    document.getElementById('combined-variation-section').classList.add('hidden');
                    document.getElementById(`${e.target.value}-variation-section`).classList.remove('hidden');
                });

                const openStockModal = (headers, rows, stockValues = []) => {
                    const tableHead = stockVariationModal.querySelector('#variation-table-head');
                    const tableBody = stockVariationModal.querySelector('#variation-stock-body');
                    tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}<th>Estoque</th></tr>`;
                    tableBody.innerHTML = rows.map((row, index) => {
                        const stockValue = stockValues[index] || 0;
                        return `<tr>
                            ${row.map(cell => `<td>${cell}</td>`).join('')}
                            <td><input type="number" min="0" value="${stockValue}"></td>
                        </tr>`;
                    }).join('');
                    stockVariationModal.classList.add('active');
                };
                
                document.getElementById('generate-simple-stock-btn').addEventListener('click', () => {
                    const name = document.getElementById('simple-variation-name').value.trim();
                    const values = document.getElementById('simple-variation-values').value.trim().split(',').map(v => v.trim());
                    if (!name || values.length === 0) {
                        showToast("Preencha o nome e os valores da variação.");
                        return;
                    }
                    openStockModal([name], values.map(v => [v]));
                });

                 document.getElementById('generate-combined-stock-btn').addEventListener('click', () => {
                    const name1 = document.getElementById('combined-variation-name-1').value.trim();
                    const values1 = document.getElementById('combined-variation-values-1').value.trim().split(',').map(v => v.trim());
                    const name2 = document.getElementById('combined-variation-name-2').value.trim();
                    const values2 = document.getElementById('combined-variation-values-2').value.trim().split(',').map(v => v.trim());

                    if (!name1 || !values1.length || !name2 || !values2.length) {
                        showToast("Preencha todos os campos das duas variações.");
                        return;
                    }

                    const combinations = [];
                    values1.forEach(v1 => {
                        values2.forEach(v2 => {
                            combinations.push([v1, v2]);
                        });
                    });
                    openStockModal([name1, name2], combinations);
                });
                
                if(stockModalCloseBtn) stockModalCloseBtn.addEventListener('click', () => stockVariationModal.classList.remove('active'));
                
                if(saveStockBtn) saveStockBtn.addEventListener('click', () => {
                    // Logic to read the table and save stock data would go here
                    // For now, we'll just close the modal and show a toast
                    const cardId = stockVariationModal.dataset.updatingCardId;
                    if (cardId) {
                        const cardToUpdate = document.getElementById(cardId);
                        let totalStock = 0;
                        const stockInputs = stockVariationModal.querySelectorAll('input[type="number"]');
                        stockInputs.forEach(input => {
                            totalStock += parseInt(input.value) || 0;
                        });
                        
                        const stockValueElement = cardToUpdate.querySelector('.stock-value');
                        if(stockValueElement) stockValueElement.textContent = totalStock;

                        cardToUpdate.dataset.totalstock = totalStock;
                        // In a real app, update the `data-variations` attribute as well
                        
                        showToast("Estoque atualizado!");
                    } else {
                        // Logic to save stock for a new product
                         showToast("Estoque salvo!");
                    }
                    stockVariationModal.classList.remove('active');
                });
                
                const buildProductCardHTML = (data) => {
                    const { name, totalStock, totalCostBase, profitMargin, profitValue, sellingPrice, imgSrc, variations } = data;
                    return `<div class="product-card-image"> <img src="${imgSrc || `https://placehold.co/400x300/db1472/ffffff?text=${name.substring(0,10)}`}" alt="Imagem de ${name}"> </div> 
                    <div class="product-card-content"> 
                        <div class="product-card-actions"> 
                            <button title="Editar" class="edit-product-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button> 
                            <button title="Excluir" class="delete-product-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button> 
                        </div> 
                        <h3 class="product-card-name">${name}</h3> 
                        <div class="product-card-details"> 
                            <div><span class="detail-label">Custo Total</span><span class="detail-value">${formatCurrency(totalCostBase)}</span></div> 
                            <div><span class="detail-label">Estoque</span><span class="detail-value stock-value">${totalStock}</span></div> 
                            <div><span class="detail-label">Lucro</span><span class="detail-value">${profitMargin}%</span></div> 
                            <div><span class="detail-label">Lucro</span><span class="detail-value">${formatCurrency(profitValue)}</span></div> 
                            <div class="product-card-price"><span class="detail-label">Preço de Venda</span><span class="detail-value">${formatCurrency(sellingPrice)}</span></div>
                            <div style="grid-column: span 2; margin-top: 0.5rem;">
                                <button class="btn btn-secondary btn-sm restock-product-btn" style="width: 100%;">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:16px; height:16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.691V5.25a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75" /></svg>
                                    Repor Estoque
                                </button>
                            </div>
                        </div> 
                    </div>`;
                };

                const setCardData = (card, data) => {
                    Object.keys(data).forEach(key => {
                        card.dataset[key.toLowerCase()] = data[key];
                    });
                };

                if(productForm) productForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('product-name').value;
                    if (!name || (parseFloat(acquisitionCostInput.value) || 0) === 0) { showToast("Preencha o nome e o custo de aquisição."); return; }
                    let totalStock = 0;
                    const variationType = document.querySelector('input[name="variationType"]:checked').value;
                    if(variationType === 'none') {
                        totalStock = parseInt(document.getElementById('single-product-stock').value) || 0;
                    } else {
                        // In a real app, this data would come from productStockData
                        totalStock = 5; // Example
                    }
                    const { totalCostBase, sellingPrice, profitMargin, profitValue, acquisitionCost } = getPriceCalculation();
                    const cardData = { name, totalStock, totalCostBase, profitMargin, profitValue, sellingPrice, imgSrc: imagePreview.src, acquisitionCost, variations: JSON.stringify(productStockData) };
                    const editingId = productForm.getAttribute('data-editing-id');
                    if(editingId) {
                        const cardToUpdate = document.getElementById(editingId);
                        cardToUpdate.innerHTML = buildProductCardHTML(cardData);
                        setCardData(cardToUpdate, cardData);
                        showToast('Produto atualizado com sucesso!');
                    } else {
                        const newCard = document.createElement('div');
                        const newCardId = `product-card-${Date.now()}`;
                        newCard.className = 'product-card';
                        newCard.id = newCardId;
                        newCard.innerHTML = buildProductCardHTML(cardData);
                        setCardData(newCard, cardData);
                        productGrid.prepend(newCard);
                        showToast('Produto salvo com sucesso!');
                    }
                    closeProductModal();
                });

                const initialProducts = [
                    { id: 'product-card-1', name: 'Vestido Rosa', acquisitionCost: 70, totalStock: 32, profitMargin: 100, imgSrc: 'https://placehold.co/400x300/f8b81f/ffffff?text=Vestido', variations: '[{"Tamanho": "P", "stock": 10}, {"Tamanho": "M", "stock": 22}]' },
                    { id: 'product-card-2', name: 'Saia Midi', acquisitionCost: 40, totalStock: 25, profitMargin: 100, imgSrc: 'https://placehold.co/400x300/db1472/ffffff?text=Saia', variations: null }
                ];

                const autoUnitCost = document.getElementById('total-unit-cost-display-top') ? parseCurrency(document.getElementById('total-unit-cost-display-top').textContent) : 0;

                if(productGrid) {
                    productGrid.innerHTML = ''; // Clear existing cards
                    initialProducts.forEach(prod => {
                        const totalCostBase = prod.acquisitionCost + autoUnitCost;
                        const sellingPrice = totalCostBase * (1 + (prod.profitMargin / 100));
                        const profitValue = sellingPrice - totalCostBase;
                        const cardData = { ...prod, totalCostBase, sellingPrice, profitValue };
                        const card = document.createElement('div');
                        card.className = 'product-card';
                        card.id = prod.id;
                        card.innerHTML = buildProductCardHTML(cardData);
                        setCardData(card, cardData);
                        productGrid.appendChild(card);
                    });
                }
            }


            // --- Expenses Page Logic (UNCHANGED) ---
            function updateExpenseCalculations() {
                let totalFixed = 0;
                document.querySelectorAll('#fixed-expense-list .expense-item').forEach(item => { totalFixed += parseFloat(item.dataset.value) || 0; });
                if(document.getElementById('total-fixed-cost-display')) document.getElementById('total-fixed-cost-display').textContent = formatCurrency(totalFixed);

                let totalVariable = 0;
                document.querySelectorAll('#variable-expense-list .expense-item').forEach(item => { totalVariable += parseFloat(item.dataset.value) || 0; });
                if(document.getElementById('total-variable-cost-display')) document.getElementById('total-variable-cost-display').textContent = formatCurrency(totalVariable);
                
                const monthlyShipping = parseFloat(document.getElementById('monthly-shipping-cost')?.value) || 0;
                const itemsSold = parseInt(document.getElementById('items-sold-monthly')?.value) || 1; 
                
                const unitFixedCost = (totalFixed + monthlyShipping) / itemsSold;
                const totalUnitCost = unitFixedCost + totalVariable;
                
                if(document.getElementById('total-unit-cost-display-top')) document.getElementById('total-unit-cost-display-top').textContent = formatCurrency(totalUnitCost);
            }

            function initializeExpensesPage() {
                const addFixedBtn = document.getElementById('add-fixed-expense-btn');
                const addVariableBtn = document.getElementById('add-variable-expense-btn');
                const expenseModal = document.getElementById('add-expense-modal');
                const expenseModalCloseBtn = expenseModal.querySelector('.modal-close');
                const expenseForm = document.getElementById('expense-form');
                const expenseModalTitle = document.getElementById('expense-modal-title');
                const expenseTypeHidden = document.getElementById('expense-type-hidden');
                const fixedExpenseFields = document.getElementById('fixed-expense-fields');
                const monthlyShippingInput = document.getElementById('monthly-shipping-cost');
                const itemsSoldInput = document.getElementById('items-sold-monthly');

                const openExpenseModal = (type) => {
                    expenseForm.reset();
                    expenseTypeHidden.value = type;
                    if (type === 'fixed') {
                        expenseModalTitle.textContent = "Adicionar Custo Fixo";
                        fixedExpenseFields.classList.remove('hidden');
                    } else {
                        expenseModalTitle.textContent = "Adicionar Custo Variável";
                        fixedExpenseFields.classList.add('hidden');
                    }
                    expenseModal.classList.add('active');
                };

                const closeExpenseModal = () => expenseModal.classList.remove('active');

                if(addFixedBtn) addFixedBtn.addEventListener('click', () => openExpenseModal('fixed'));
                if(addVariableBtn) addVariableBtn.addEventListener('click', () => openExpenseModal('variable'));
                if(expenseModalCloseBtn) expenseModalCloseBtn.addEventListener('click', closeExpenseModal);
                
                if(expenseForm) expenseForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('expense-name').value;
                    const value = parseFloat(document.getElementById('expense-value').value);
                    const category = document.getElementById('expense-category').value;
                    const type = expenseTypeHidden.value;
                    if(!name || !value) { showToast("Por favor, preencha o nome e o valor da despesa."); return; }
                    const newItem = document.createElement('li');
                    newItem.className = 'expense-item';
                    newItem.dataset.value = value.toFixed(2);
                    newItem.dataset.category = category;
                    
                    if (type === 'fixed') {
                        const date = document.getElementById('expense-due-date').value;
                        const recurrence = document.getElementById('expense-recurrence').value;
                        newItem.innerHTML = `<div><span>${name}</span><div class="details">Vence em: ${date ? new Date(date + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'} (${recurrence})<span class="expense-category-tag">${category}</span></div></div><strong>${formatCurrency(value)}</strong>`;
                        document.getElementById('fixed-expense-list').appendChild(newItem);
                    } else {
                        newItem.innerHTML = `<div><span>${name}</span><span class="expense-category-tag">${category}</span></div><strong>${formatCurrency(value)}</strong>`;
                        document.getElementById('variable-expense-list').appendChild(newItem);
                    }
                    updateExpenseCalculations();
                    closeExpenseModal();
                    showToast("Despesa adicionada com sucesso!");
                });

                if(monthlyShippingInput) monthlyShippingInput.addEventListener('input', updateExpenseCalculations);
                if(itemsSoldInput) itemsSoldInput.addEventListener('input', updateExpenseCalculations);
                updateExpenseCalculations();
            }
            
            // --- Financeiro Page Logic (UNCHANGED) ---
            function initializeFinanceiroPage() {
                const addTransactionBtn = document.getElementById('add-manual-transaction-btn');
                const transactionModal = document.getElementById('add-transaction-modal');
                const transactionModalClose = transactionModal.querySelector('.modal-close');
                const exportReportBtn = document.getElementById('export-report-btn');
                const financePage = document.getElementById('financeiro-page');

                if(addTransactionBtn) {
                    addTransactionBtn.addEventListener('click', () => {
                        transactionModal.classList.add('active');
                    });
                }
                
                if(transactionModalClose) {
                     transactionModalClose.addEventListener('click', () => {
                        transactionModal.classList.remove('active');
                    });
                }
                
                if(exportReportBtn) {
                    exportReportBtn.addEventListener('click', () => {
                        showToast('Funcionalidade de exportação em desenvolvimento!');
                    });
                }

                financePage.addEventListener('click', (e) => {
                    if (e.target.classList.contains('action-btn')) {
                        const button = e.target;
                        button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" style="width:20px; height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg> OK';
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-success');
                        button.disabled = true;
                    }
                });

                // Bar Chart - Cash Flow
                const cashFlowCtx = document.getElementById('cashFlowChart');
                if(cashFlowCtx) {
                    new Chart(cashFlowCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Março', 'Abril', 'Maio', 'Junho'],
                            datasets: [
                                { label: 'Entradas', data: [5200, 6100, 7500, 7850], backgroundColor: 'rgba(34, 197, 94, 0.6)', borderColor: 'rgba(34, 197, 94, 1)', borderWidth: 1 },
                                { label: 'Saídas', data: [1500, 1800, 1100, 1230], backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1 }
                            ]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: true } } }
                    });
                }

                // Pie Chart - Expenses by Category
                const categoryCtx = document.getElementById('expensesByCategoryChart');
                if (categoryCtx) {
                    const expenseItems = document.querySelectorAll('#despesas-page .expense-item');
                    const categoryTotals = {};
                    expenseItems.forEach(item => {
                        const category = item.dataset.category || 'Outros';
                        const value = parseFloat(item.dataset.value) || 0;
                        if(categoryTotals[category]) {
                            categoryTotals[category] += value;
                        } else {
                            categoryTotals[category] = value;
                        }
                    });

                    new Chart(categoryCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(categoryTotals),
                            datasets: [{
                                label: 'Despesas por Categoria',
                                data: Object.values(categoryTotals),
                                backgroundColor: ['#db1472', '#f8b81f', '#3b82f6', '#22c55e', '#8b5cf6'],
                                hoverOffset: 4
                            }]
                        },
                        options: { responsive: true }
                    });
                }
            }


            // --- CRM Page Logic (UNCHANGED) ---
            function initializeCrmPage() {
                const addClientBtn = document.getElementById('add-client-btn');
                const clientModal = document.getElementById('add-edit-client-modal');
                const clientModalCloseButtons = clientModal.querySelectorAll('.modal-close');
                const clientForm = document.getElementById('new-client-form');
                const clientModalTitle = document.getElementById('client-modal-title');
                const clientListBody = document.getElementById('client-list-body');
                
                const historyModal = document.getElementById('client-history-modal');
                const historyModalClose = historyModal.querySelector('.modal-close');
                const historyModalTitle = document.getElementById('client-history-modal-title');
                const historyList = document.getElementById('client-history-list');

                const openClientModal = (isEdit = false, data = {}) => {
                    clientForm.reset();
                    clientModalTitle.textContent = isEdit ? "Editar Cliente" : "Adicionar Novo Cliente";
                    document.getElementById('client-id').value = data.id || '';
                    document.getElementById('client-name').value = data.name || '';
                    document.getElementById('client-phone').value = data.phone || '';
                    document.getElementById('client-email').value = data.email || '';
                    document.getElementById('client-address').value = data.address || '';
                    document.getElementById('client-birthdate').value = data.birthdate || '';
                    clientModal.classList.add('active');
                };

                const closeClientModal = () => clientModal.classList.remove('active');
                
                const openHistoryModal = (clientName) => {
                    historyModalTitle.textContent = `Histórico de Compras de ${clientName}`;
                    historyList.innerHTML = `
                        <tr><td>25/06/2025</td><td>Vestido Rosa</td><td>R$ 150,00</td></tr>
                        <tr><td>10/05/2025</td><td>Saia Midi, Calça Jeans</td><td>R$ 300,40</td></tr>
                    `;
                    historyModal.classList.add('active');
                };
                const closeHistoryModal = () => historyModal.classList.remove('active');

                if (addClientBtn) {
                    addClientBtn.addEventListener('click', () => openClientModal());
                }
                
                if (clientModalCloseButtons) {
                    clientModalCloseButtons.forEach(btn => btn.addEventListener('click', closeClientModal));
                }

                if (clientForm) {
                    clientForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const clientData = {
                            id: document.getElementById('client-id').value || Date.now(),
                            name: document.getElementById('client-name').value,
                            phone: document.getElementById('client-phone').value,
                            email: document.getElementById('client-email').value,
                            address: document.getElementById('client-address').value,
                            birthdate: document.getElementById('client-birthdate').value
                        };
                        addClientToCrmTable(clientData);
                        showToast("Cliente salvo com sucesso!");
                        closeClientModal();
                    });
                }

                if (historyModalClose) historyModalClose.addEventListener('click', closeHistoryModal);

                if (clientListBody) {
                    clientListBody.addEventListener('click', (e) => {
                        const button = e.target.closest('button');
                        if (!button) return;

                        const row = button.closest('tr');
                        const clientData = row.dataset;

                        if (button.classList.contains('delete-client-btn')) {
                            row.remove();
                            showToast('Cliente excluído com sucesso!');
                        } else if (button.classList.contains('edit-client-btn')) {
                            openClientModal(true, clientData);
                        } else if (button.classList.contains('whatsapp-icon')) {
                            const phone = clientData.phone.replace(/[^0-9]/g, '');
                            if (phone) {
                                window.open(`https://wa.me/55${phone}`, '_blank');
                            } else {
                                showToast('Número de telefone não encontrado.');
                            }
                        } else if (button.classList.contains('history-client-btn')) {
                            openHistoryModal(clientData.name);
                        }
                    });
                }
            }
        });

        // --- Chart Initializers (Existing, untouched) ---
        function initializeDashboardCharts() {
            // This function exists but is empty as it's not the focus.
            // In a real scenario, the chart logic would be here.
        }
    </script>

</body>
</html>
