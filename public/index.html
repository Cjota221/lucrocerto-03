<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucro Certo - App</title>
    
    <!-- Google Fonts: Poppins (Títulos) e Open Sans (Textos) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CSS Reset & Base --- */
        :root {
            --pink: #db1472;
            --pink-light: #fce7f3;
            --gold: #f8b81f;
            --gold-light: #fbcd6a;
            --text-dark: #1f2937;
            --text-light: #4b5563;
            --background: #f9fafb;
            --white: #ffffff;
            --border-color: #e5e7eb;
            --success: #22c55e;
            --blue: #3b82f6;

            --font-primary: 'Poppins', sans-serif;
            --font-secondary: 'Open Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-secondary);
            background-color: var(--background);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
        }

        .hidden { display: none !important; }

        /* --- Estilos da Experiência de Entrada (Landing/Auth) --- */
        #entry-wrapper {
             width: 100%;
        }

        .entry-page {
            display: none;
            width: 100%;
            animation: fadeIn 0.6s ease-in-out;
        }
        .entry-page.active {
            display: block;
        }
        
        /* Cabeçalho da Landing Page */
        .landing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .landing-header .logo {
            font-family: var(--font-primary);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--pink);
        }
        .landing-header .nav-actions {
            display: flex;
            gap: 1rem;
        }

        /* Seção Hero */
        .hero-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 6rem 2rem;
            background: linear-gradient(135deg, var(--pink-light) 0%, #fffde7 100%);
        }
        .hero-section h1 {
            font-family: var(--font-primary);
            font-size: 3rem;
            color: var(--text-dark);
            max-width: 600px;
            margin-bottom: 1rem;
        }
        .hero-section p {
            font-size: 1.25rem;
            color: var(--text-light);
            max-width: 550px;
            margin-bottom: 2rem;
        }
        
        /* Página de Autenticação */
        #auth-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--pink) 0%, var(--gold) 100%);
        }
        .auth-container {
            width: 100%;
            max-width: 420px;
            background-color: var(--white);
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        .auth-container h2 {
            font-family: var(--font-primary);
            text-align: center;
            color: var(--text-dark);
            margin-bottom: 2rem;
        }
        .auth-toggle-link {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.9rem;
        }
        .auth-toggle-link a {
            color: var(--pink);
            font-weight: 600;
            cursor: pointer;
        }

        /* --- App Layout --- */
        #app-container { display: flex; min-height: 100vh; }
        #sidebar {
            width: 260px; background-color: var(--white); border-right: 1px solid var(--border-color);
            padding: 1.5rem; position: fixed; left: -260px; top: 0; height: 100%;
            transition: left 0.3s ease-in-out; z-index: 300; display: flex; flex-direction: column;
            overflow-y: auto; 
        }
        #sidebar.active { left: 0; }
        #main-content { flex-grow: 1; padding: 1.5rem; width: 100%; }
        
        #sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 299; 
        }
        #sidebar-overlay.active {
            display: block;
        }

        /* --- Sidebar Menu --- */
        .sidebar-header { font-family: var(--font-primary); font-size: 1.5rem; font-weight: 700; color: var(--pink); padding-left: 0.5rem; margin-bottom: 2rem; }
        .sidebar-nav { 
            list-style: none; 
        }
        .sidebar-nav li a {
            display: flex; align-items: center; gap: 1rem; padding: 0.85rem 1rem; margin-bottom: 0.5rem;
            border-radius: 0.5rem; text-decoration: none; font-family: var(--font-primary); font-weight: 600;
            font-size: 0.95rem; color: var(--text-light); transition: background-color 0.2s ease, color 0.2s ease;
        }
        .sidebar-nav li a svg { width: 22px; height: 22px; }
        .sidebar-nav li a:hover { background-color: var(--pink-light); color: var(--pink); }
        .sidebar-nav li a.active { background-color: var(--pink); color: var(--white); box-shadow: 0 4px 6px -1px rgba(219, 20, 114, 0.3); }
        .sidebar-footer { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: auto; }

        /* --- Header --- */
        .header {
            display: flex; align-items: center; background-image: linear-gradient(to right, var(--pink), var(--gold));
            color: var(--white); padding: 1rem 1.5rem; margin-bottom: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .header-title { font-family: var(--font-primary); font-size: 1.25rem; font-weight: 700; color: var(--white); }
        .menu-toggle { background: none; border: none; cursor: pointer; margin-right: 1rem; font-size: 1.5rem; color: var(--white); }
        
        /* --- Page Sections (for SPA) --- */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;}
        .page-title { font-family: var(--font-primary); font-size: 1.5rem; color: var(--text-dark); }

        /* --- Grid & Card Styles --- */
        .cards-grid { display: grid; gap: 1.5rem; grid-template-columns: 1fr; }
        @media (min-width: 1024px) {
             .cards-grid.dashboard-grid { grid-template-columns: repeat(3, 1fr); }
             .cards-grid.vendas-grid { grid-template-columns: 2fr 1fr; align-items: flex-start; }
        }
        @media (min-width: 768px) {
            .cards-grid.two-cols { grid-template-columns: repeat(2, 1fr); }
            .cards-grid.quick-actions-grid { grid-template-columns: repeat(4, 1fr); }
            .cards-grid.summary-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (min-width: 500px) and (max-width: 767px) {
             .cards-grid.summary-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 767px) {
             .cards-grid.quick-actions-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem;}
        }

        .card { background-color: var(--white); border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .card-title { font-family: var(--font-primary); font-weight: 600; font-size: 1.2rem; color: var(--text-dark); margin-bottom: 1rem; }
        .card-title-small { font-size: 1rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .card-value { font-family: var(--font-primary); font-weight: 700; font-size: 2rem; color: var(--pink); }
        .card-value-small { font-family: var(--font-primary); font-size: 1.5rem; color: var(--text-dark); }
        .info-card { background-color: var(--pink-light); padding: 1rem; border-radius: 0.5rem; }
        .info-card p { color: var(--pink); font-family: var(--font-secondary); }
        .info-card strong { font-family: var(--font-primary); }

        /* --- Button Styles --- */
        .btn {
            font-family: var(--font-primary); font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            border: none; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn:not(:disabled):hover { transform: translateY(-2px); }
        .btn:disabled { cursor: not-allowed; background-color: #d1d5db; color: #6b7280; }
        .btn-primary { background-color: var(--pink); color: var(--white); }
        .btn-primary:not(:disabled):hover { background-color: #be1265; }
        .btn-secondary { background-color: var(--pink-light); color: var(--pink); }
        .btn-secondary:not(:disabled):hover { background-color: #fbcfe8; }
        .btn-danger { background-color: #fee2e2; color: #ef4444; }
        .btn-danger:hover { background-color: #fecaca; }
        .btn-success { background-color: var(--success); color: var(--white); }
        .btn-success:not(:disabled):hover { background-color: #16a34a; }
        .btn-whatsapp { background-color: var(--success); color: var(--white); }
        .btn-whatsapp:not(:disabled):hover { background-color: #16a34a; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn.btn-full { width: 100%; }
        
        .quick-action-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.75rem; background-image: linear-gradient(135deg, var(--pink), var(--gold)); color: var(--white); padding: 1.5rem 1rem; border-radius: 0.75rem; font-family: var(--font-primary); font-weight: 700; font-size: 1rem; text-decoration: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .quick-action-btn svg { width: 28px; height: 28px; }
        .quick-action-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        
        /* --- Form Styles --- */
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-family: var(--font-primary); font-weight: 600; margin-bottom: 0.5rem; color: var(--text-light); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;
            font-size: 1rem; font-family: var(--font-secondary);
        }
        .form-group textarea { min-height: 80px; }
        .form-actions { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: flex-end; }
        .form-actions .btn { flex-grow: 0; }
        .link-style { color: var(--blue); cursor: pointer; text-decoration: underline; font-size: 0.9rem; margin-top: 0.5rem; display: inline-block;}
        
        /* --- Table Styles --- */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); font-family: var(--font-secondary); vertical-align: middle;}
        th { font-family: var(--font-primary); font-weight: 600; color: var(--text-light); }
        .status-paid { color: var(--success); font-weight: 600; }
        .status-pending { color: var(--gold); font-weight: 600; }

        .table-actions { display: flex; gap: 0.5rem; justify-content: flex-start; }
        .table-actions button { background: none; border: none; cursor: pointer; padding: 0.25rem; color: var(--text-light); }
        .table-actions button:hover { color: var(--pink); }
        .table-actions .history-client-btn:hover { color: var(--blue); }
        .table-actions svg { width: 20px; height: 20px; }
        .table-actions .whatsapp-icon:hover { color: var(--success); }
        
        /* --- Modal (Pop-up) Styles --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow-y: auto; background-color: rgba(0,0,0,0.6); 
            align-items: flex-start; justify-content: center;
            padding: 2rem 0;
        }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        .modal-content {
            background-color: var(--white); padding: 2rem; border-radius: 0.75rem;
            width: 90%; 
            position: relative;
            animation: slideIn 0.3s ease-out;
            margin: 0 auto;
        }
        #add-edit-product-modal .modal-content, #stock-variation-modal .modal-content, #client-history-modal .modal-content, #sale-receipt-modal .modal-content { max-width: 900px; }
        #add-expense-modal .modal-content, #add-edit-client-modal .modal-content, #add-transaction-modal .modal-content, #notification-modal .modal-content { max-width: 600px; }

        @media (max-width: 767px) {
            #add-edit-product-modal .modal-content { max-width: 90%; }
        }
        
        @keyframes slideIn { from { transform: translateY(-30px); } to { transform: translateY(0); } }
        .modal-close {
            position: absolute; top: 1rem; right: 1rem; background: none; border: none;
            font-size: 1.5rem; cursor: pointer; color: var(--text-light);
        }
        .product-list .product-item {
            display: flex; justify-content: space-between; align-items: center; padding: 1rem;
            border: 1px solid var(--border-color); border-radius: 0.5rem; margin-bottom: 1rem; cursor: pointer;
            transition: background-color 0.2s;
        }
        .product-list .product-item:hover { background-color: var(--pink-light); }
        
        /* --- Toast & Notification Styles --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast {
            background-color: var(--text-dark); color: var(--white); padding: 1rem 1.5rem;
            border-radius: 0.5rem; margin-top: 1rem; font-family: var(--font-primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0;
            transform: translateY(20px); animation: toastIn 0.5s forwards;
        }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
        #notification-list { list-style: none; padding-left: 0; }
        #notification-list li { background-color: var(--pink-light); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; color: var(--pink); border-left: 4px solid var(--pink); }
        #notification-list li strong { font-family: var(--font-primary); }

        /* --- Vendas Page Styles --- */
        .sale-summary-card { position: sticky; top: 1.5rem; }
        .summary-line { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 1rem; }
        .summary-line.total { font-family: var(--font-primary); font-weight: 700; font-size: 1.5rem; color: var(--pink); border-top: 2px dashed var(--border-color); padding-top: 1rem; margin-top: 1rem; }
        .selected-product-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .selected-product-item button { color: #ef4444; background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        #discount-type-group { display: flex; align-items: center; gap: 0.5rem; }
        #discount-type-group select { width: auto; }
        
        /* --- Product Page Styles --- */
        .product-card-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
        .product-card {
            background: var(--white); border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden; display: flex; flex-direction: column;
        }
        .product-card-image {
            height: 180px; background-color: var(--border-color);
            display: flex; align-items: center; justify-content: center; color: var(--text-light);
        }
        .product-card-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-card-content { padding: 1rem; flex-grow: 1; position: relative; }
        .product-card-name { font-family: var(--font-primary); font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 1rem; padding-right: 60px; }
        
        .product-card-actions {
            position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem;
        }
        .product-card-actions button {
            background: none; border: none; cursor: pointer; padding: 0.25rem; color: var(--text-light);
        }
        .product-card-actions button:hover { color: var(--pink); }
        .product-card-actions svg { width: 20px; height: 20px; }

        .product-card-details {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;
            font-size: 0.875rem;
        }
        .product-card-details > div {
            background-color: var(--background); padding: 0.5rem; border-radius: 0.25rem;
        }
        .product-card-details .detail-label {
            display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;
        }
        .product-card-details .detail-value {
            font-weight: 700; color: var(--text-dark);
        }
        .product-card-price {
            grid-column: span 2; background-color: var(--pink-light) !important; text-align: center;
        }
        .product-card-price .detail-value {
            color: var(--pink); font-size: 1.25rem; font-family: var(--font-primary);
        }


        /* --- Despesas Page Styles --- */
        .info-text {
            font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;
            line-height: 1.5;
        }
        .expense-list { list-style: none; padding: 0; }
        .expense-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .expense-item .expense-info { flex-grow: 1; }
        .expense-item:first-of-type { padding-top: 0; }
        .expense-item:last-child { border-bottom: none; }
        .expense-item span { font-size: 1rem; }
        .expense-item strong { font-family: var(--font-primary); }
        .expense-item .details { font-size: 0.8rem; color: var(--text-light); }
        .expense-category-tag {
            background-color: var(--blue); color: var(--white);
            font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 999px;
            margin-left: 0.5rem; font-family: var(--font-primary);
        }
        
        .calculator-card { background: var(--pink-light); }
        .calculator-result {
            font-family: var(--font-primary);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--pink);
            text-align: center;
            margin-top: 1rem;
        }

        /* --- Add Product & Precificar Page Styles --- */
        .fieldset {
            border: 1px solid var(--border-color); border-radius: 0.5rem;
            padding: 1rem; margin-bottom: 1.5rem;
        }
        .fieldset legend {
            padding: 0 0.5rem; font-family: var(--font-primary); font-weight: 600;
            color: var(--text-dark);
        }
        .radio-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .radio-group label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem; }
        
        .pricing-calculator-section { background: var(--background); padding: 1.5rem; border-radius: 0.5rem; }
        .pricing-slider-container { margin: 1.5rem 0; }
        .pricing-slider-container input[type="range"] { width: 100%; cursor: pointer; }
        .pricing-result-card {
            background-image: linear-gradient(to right, var(--pink), var(--gold)); color: var(--white);
            padding: 1.5rem; border-radius: 0.75rem; text-align: center;
        }
        .pricing-result-card .result-label { font-size: 1rem; opacity: 0.9; }
        .pricing-result-card .result-value { font-family: var(--font-primary); font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0; }
        .pricing-result-card .result-details { display: flex; justify-content: space-around; margin-top: 1rem; }
        
        .other-costs-container .dynamic-field { display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem; }
        .other-costs-container .dynamic-field input { flex-grow: 1; }
        .other-costs-container .dynamic-field button { padding: 0.5rem; border-radius: 50%; width: 32px; height: 32px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        
        #stock-variation-modal .modal-content { max-width: 600px; }
        #stock-variation-modal table { width: 100%; }
        #stock-variation-modal th, #stock-variation-modal td { padding: 0.75rem; }
        #stock-variation-modal input { width: 100%; padding: 0.5rem; }

        .modal-form-grid {
            display: grid; grid-template-columns: 1fr; gap: 2rem;
        }
        @media (min-width: 768px) {
            .modal-form-grid { grid-template-columns: 1fr 1fr; }
        }

        .image-preview-container {
            width: 100%; height: 150px; background-color: var(--background);
            border: 2px dashed var(--border-color); border-radius: 0.5rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; margin-bottom: 1rem;
        }
        .image-preview-container img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview-container span { color: var(--text-light); }

        /* --- Perfil Page Styles --- */
        .profile-header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background-color: var(--border-color); border: 4px solid var(--white); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); position: relative; cursor: pointer; overflow: hidden; }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-avatar .overlay { position: absolute; bottom: 0; left: 0; right: 0; background-color: rgba(0,0,0,0.5); color: white; text-align: center; padding: 0.25rem; font-size: 0.75rem; opacity: 0; transition: opacity 0.2s ease; }
        .profile-avatar:hover .overlay { opacity: 1; }
        .profile-info h2 { font-family: var(--font-primary); font-size: 1.5rem; }
        .profile-info p { color: var(--text-light); }

        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-link { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -1px; font-family: var(--font-primary); font-weight: 600; color: var(--text-light); }
        .tab-link.active { border-color: var(--pink); color: var(--pink); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        
        .subscription-card { border: 2px solid var(--gold); border-radius: 0.75rem; padding: 2rem; background-image: linear-gradient(135deg, var(--pink-light), #fff8e1); text-align: center; }
        .subscription-card .badge { display: inline-block; background-color: var(--gold); color: var(--text-dark); padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.8rem; font-weight: 700; margin-bottom: 1rem; }
        .subscription-card h3 { font-family: var(--font-primary); font-size: 1.8rem; color: var(--text-dark); }
        .subscription-card p { color: var(--text-light); margin: 0.5rem 0 1.5rem 0; }

        /* --- Utility --- */
        .mb-4 { margin-bottom: 1.5rem; }
        .mt-4 { margin-top: 1.5rem; }
        .text-center { text-align: center; }
        hr { border: none; border-top: 1px solid var(--border-color); margin: 2rem 0; }

        @media print {
            body * {
                visibility: hidden;
            }
            #sale-receipt-modal, #sale-receipt-modal * {
                visibility: visible;
            }
            #sale-receipt-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background-color: white;
                display: block !important;
                padding: 1rem;
            }
            #sale-receipt-modal .modal-content {
                box-shadow: none;
                border: none;
                padding: 0;
                max-width: 100%;
            }
            #sale-receipt-modal .modal-close,
            #sale-receipt-modal .form-actions {
                display: none;
            }
        }

    </style>
</head>
<body>
    
    <!-- ### CONTAINER DA EXPERIÊNCIA DE ENTRADA (NOVO) ### -->
    <div id="entry-wrapper">
        <!-- PÁGINA DE VENDAS (LANDING PAGE) -->
        <section id="landing-page" class="entry-page active">
            <header class="landing-header">
                <div class="logo">Lucro Certo</div>
                <div class="nav-actions">
                    <button id="goto-login-btn" class="btn btn-secondary">Login</button>
                    <button id="goto-register-btn" class="btn btn-primary">Cadastro</button>
                </div>
            </header>
            <main class="hero-section">
                <h1>A gestão financeira que seu negócio de moda merece.</h1>
                <p>Do controle de estoque à precificação inteligente, o Lucro Certo é a ferramenta que transforma seus dados em decisões e suas vendas em lucro.</p>
                <button id="start-now-btn" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1.1rem;">Criar Minha Conta Grátis</button>
            </main>
        </section>

        <!-- PÁGINA DE AUTENTICAÇÃO (LOGIN/CADASTRO) -->
        <section id="auth-page" class="entry-page">
            <div class="auth-container">
                <!-- FORMULÁRIO DE LOGIN -->
                <div id="login-form" class="auth-form active">
                    <h2>Bem-vinda de Volta!</h2>
                    <form>
                        <div class="form-group">
                            <label for="login-email">E-mail</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">Senha</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <button type="button" id="login-btn" class="btn btn-primary btn-full">Entrar</button>
                    </form>
                    <p class="auth-toggle-link">Não tem uma conta? <a id="show-register">Cadastre-se</a></p>
                </div>

                <!-- FORMULÁRIO DE CADASTRO -->
                <div id="register-form" class="auth-form">
                    <h2>Crie sua Conta</h2>
                    <form>
                         <div class="form-group">
                            <label for="register-name">Nome</label>
                            <input type="text" id="register-name" required>
                        </div>
                        <div class="form-group">
                            <label for="register-email">E-mail</label>
                            <input type="email" id="register-email" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password">Senha</label>
                            <input type="password" id="register-password" required>
                        </div>
                        <button type="button" id="register-btn" class="btn btn-primary btn-full">Criar Conta</button>
                    </form>
                    <p class="auth-toggle-link">Já tem uma conta? <a id="show-login">Faça login</a></p>
                </div>
            </div>
        </section>
    </div>

    <!-- ### CONTAINER DO APLICATIVO PRINCIPAL (AGORA ENCAPSULADO E OCULTO) ### -->
    <div id="app-wrapper" class="hidden">
        <div id="app-container">
            <!-- ### SIDEBAR ### -->
            <nav id="sidebar">
                <div style="flex-grow: 1;">
                    <h2 class="sidebar-header">Lucro Certo</h2>
                    <ul class="sidebar-nav">
                        <li><a href="#dashboard" class="nav-link active">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" /></svg>
                            <span>Dashboard</span>
                        </a></li>
                        <li><a href="#vendas" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l.383-1.437M7.5 14.25L5.106 5.165A2.25 2.25 0 0 0 2.894 3.75H2.25" /></svg>
                            <span>Vendas</span>
                        </a></li>
                        <li><a href="#produtos" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" /></svg>
                            <span>Produtos</span>
                        </a></li>
                        <li><a href="#precificar" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.826-1.106-2.251 0-3.078s2.76-1.226 4.003-.659c.345.259.69.608.998 1.024v-2.253" /></svg>
                            <span>Precificar</span>
                        </a></li>
                        <li><a href="#despesas" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" /></svg>
                            <span>Despesas</span>
                        </a></li>
                        <li><a href="#financeiro" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V6.375c0-.621.504-1.125 1.125-1.125h.375m16.5 0h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375" /></svg>
                            <span>Financeiro</span>
                        </a></li>
                        <li><a href="#crm" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                            <span>CRM</span>
                        </a></li>
                    </ul>
                </div>
                <div class="sidebar-footer">
                     <ul class="sidebar-nav">
                         <li><a href="#perfil" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.227a48.11 48.11 0 0 1 3.076 0c.55.22 1.02.685 1.11 1.227l.588 3.528a2.25 2.25 0 0 0 2.223 1.884h3.528c.542 0 1.007.368 1.227.877a48.097 48.097 0 0 1 0 3.076c-.22.51-.685 1.02-1.227 1.11l-3.528.588a2.25 2.25 0 0 0-1.884 2.223v3.528c0 .542-.368 1.007-.877 1.227a48.097 48.097 0 0 1-3.076 0c-.51-.22-1.02-.685-1.11-1.227l-.588-3.528a2.25 2.25 0 0 0-2.223-1.884h-3.528c-.542 0-1.007-.368-1.227-.877a48.097 48.097 0 0 1 0-3.076c.22-.51.685 1.02 1.227-1.11l3.528-.588a2.25 2.25 0 0 0 1.884-2.223l.588-3.528Z" /></svg>
                            <span>Perfil</span>
                        </a></li>
                          <li><a href="#logout" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" /></svg>
                            <span>Sair</span>
                        </a></li>
                     </ul>
                </div>
            </nav>
            
            <div id="sidebar-overlay"></div>
    
            <div id="main-content">
                <header class="header">
                     <button class="menu-toggle" aria-label="Abrir menu">☰</button>
                     <h1 id="page-main-title" class="header-title">Olá, Maria!</h1>
                </header>
    
                <!-- ### DASHBOARD PAGE ### -->
                <section id="dashboard-page" class="page active">
                     <div class="cards-grid quick-actions-grid mb-4">
                         <a href="#vendas" class="quick-action-btn nav-link"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> <span>Nova Venda</span> </a>
                         <a href="#produtos" class="quick-action-btn nav-link"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" /></svg> <span>Meus Produtos</span> </a>
                         <a href="#precificar" class="quick-action-btn nav-link"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.826-1.106-2.251 0-3.078s2.76-1.226 4.003-.659c.345.259.69.608.998 1.024v-2.253" /></svg> <span>Precificar</span> </a>
                         <a href="#financeiro" class="quick-action-btn nav-link"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" /></svg> <span>Financeiro</span> </a>
                    </div>
                    <div class="cards-grid summary-grid mb-4">
                        <div class="card"> <h3 class="card-title">Faturamento do Mês</h3> <p class="card-value">R$ 7.850,00</p> </div>
                        <div class="card"> <h3 class="card-title">Lucro Estimado</h3> <p class="card-value">R$ 3.140,00</p> </div>
                        <div class="card"> <h3 class="card-title">Despesas do Mês</h3> <p class="card-value">R$ 1.230,00</p> </div>
                        <div class="card"> <h3 class="card-title">Peças em Estoque</h3> <p class="card-value">128</p> </div>
                    </div>
                    <div class="card mb-4">
                        <h3 class="card-title">Ponto de Equilíbrio</h3> <p class="card-value card-value-small">R$ 4.500,00</p>
                        <div class="progress-bar-container" style="width: 100%; background-color: var(--border-color); border-radius: 999px; height: 10px; margin-top: 1rem; overflow: hidden;"> <div class="progress-bar" style="height: 100%; border-radius: 999px; transition: width 0.5s ease-in-out; background-color: var(--success); width: 85%;"></div> </div>
                        <div class="progress-labels" style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-light);"> <span>Atingido</span> <span>Meta</span> </div>
                    </div>
                    <div class="cards-grid two-cols">
                        <div class="card"> <h3 class="card-title text-center mb-4">Meta de Faturamento Mensal</h3> <canvas id="goalChart"></canvas> </div>
                        <div class="card"> <h3 class="card-title text-center mb-4">Produtos Mais Vendidos</h3> <canvas id="topProductsChart"></canvas> </div>
                        <div class="card"> <h3 class="card-title text-center mb-4">Top Produtos por Lucro</h3> <canvas id="topProfitChart"></canvas> </div>
                        <div class="card"> <h3 class="card-title text-center mb-4">Distribuição de Custos</h3> <canvas id="costsChart"></canvas> </div>
                    </div>
                </section>
                
                <!-- ### VENDAS PAGE ### -->
                <section id="vendas-page" class="page">
                    <div class="page-header"> <h2 class="page-title">Ponto de Venda (PDV)</h2> </div>
                    <div class="cards-grid vendas-grid">
                        <div id="pdv-form-container" class="card">
                            <form id="sale-form">
                                <div class="form-group">
                                    <label for="customer-search">Cliente</label>
                                    <input type="search" id="customer-search" placeholder="Buscar cliente ou cadastrar um novo">
                                    <button type="button" id="show-customer-form-btn" class="btn btn-secondary mt-4">Cadastrar Novo Cliente</button>
                                </div>
                                <div id="new-customer-form" class="hidden card" style="background-color: var(--pink-light); margin-bottom: 1rem;">
                                     <h3 class="card-title" style="color: var(--pink);">Cadastro Rápido de Cliente</h3>
                                     <div class="form-group"> <label for="new-customer-name">Nome do Cliente (Obrigatório)</label> <input type="text" id="new-customer-name" required placeholder="Ex: Joana Silva"> </div>
                                     <div class="form-group"> <label for="new-customer-phone">Telefone do Cliente (Obrigatório)</label> <input type="tel" id="new-customer-phone" required placeholder="(XX) 99999-9999"> </div>
                                     <span id="advanced-customer-toggle" class="link-style">Cadastro Avançado (Opcional)</span>
                                     <div id="advanced-customer-fields" class="hidden mt-4">
                                        <div class="form-group"> <label for="new-customer-cpf">CPF</label> <input type="text" id="new-customer-cpf" placeholder="000.000.000-00"> </div>
                                        <div class="form-group"> <label for="new-customer-email">E-mail</label> <input type="email" id="new-customer-email" placeholder="email@exemplo.com"> </div>
                                        <div class="form-group"> <label for="new-customer-address">Endereço</label> <input type="text" id="new-customer-address" placeholder="Rua, Número, Bairro..."> </div>
                                     </div>
                                     <button type="button" id="save-customer-btn" class="btn btn-primary mt-4">Salvar Cliente</button>
                                </div>
                                 <div class="form-group">
                                    <label>Produtos</label>
                                    <div id="selected-products-list" style="border: 1px dashed var(--border-color); padding: 1rem; border-radius: .5rem; min-height: 50px;">
                                        <p id="no-products-message" class="text-light">Nenhum produto adicionado.</p>
                                    </div>
                                    <button type="button" id="add-product-btn" class="btn btn-secondary mt-4">Adicionar Produto</button>
                                </div>
                                 <fieldset class="fieldset">
                                    <legend>Desconto</legend>
                                    <div class="form-group" id="discount-type-group">
                                        <select id="discount-type"> <option value="percentage">%</option> <option value="fixed">R$</option> </select>
                                        <input type="number" id="discount-value" placeholder="Aplicar desconto">
                                    </div>
                                </fieldset>
                                 <div class="form-group">
                                    <label for="payment-method">Forma de Pagamento</label>
                                    <select id="payment-method"> <option value="pix">Pix</option> <option value="credito">Cartão de Crédito</option> <option value="debito">Cartão de Débito</option> <option value="dinheiro">Dinheiro</option> <option value="carne">Carnê (Fiado)</option> </select>
                                </div>
                                <div id="installments-group" class="form-group hidden">
                                    <label for="installments-count">Número de Parcelas</label>
                                    <input type="number" id="installments-count" value="1" min="1">
                                </div>
                                 <div class="form-group"> <label for="sale-observations">Observações (Opcional)</label> <textarea id="sale-observations" placeholder="Ex: Cliente pediu para reservar a peça X..."></textarea> </div>
                            </form>
                        </div>
                        <div class="sale-summary-card card">
                            <h3 class="card-title">Resumo da Venda</h3>
                            <div class="summary-line"> <span>Subtotal</span> <span id="summary-subtotal">R$ 0,00</span> </div>
                            <div class="summary-line"> <span>Desconto</span> <span id="summary-discount">R$ 0,00</span> </div>
                            <div class="summary-line total"> <span>Total</span> <span id="summary-total">R$ 0,00</span> </div>
                            <div class="form-actions" style="margin-top: 2rem;">
                                <button type="button" id="finish-sale-btn" class="btn btn-primary" style="width:100%"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px; height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg> Finalizar Venda </button>
                            </div>
                        </div>
                    </div>
                    <div class="page-header mt-4"> <h2 class="page-title">Histórico de Vendas</h2> </div>
                     <div class="card">
                         <div class="table-wrapper">
                             <table>
                                 <thead> <tr> <th>Cliente</th> <th>Data</th> <th>Valor</th> <th>Status</th> <th>Ações</th> </tr> </thead>
                                 <tbody id="sales-history-body">
                                     <!-- Sales history will be rendered here by JS -->
                                 </tbody>
                             </table>
                         </div>
                     </div>
                </section>
    
                <!-- ### PRODUTOS PAGE ### -->
                <section id="produtos-page" class="page">
                    <div class="page-header">
                        <h2 class="page-title">Meus Produtos</h2>
                        <button id="open-add-product-modal-btn" class="btn btn-primary"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px; height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Adicionar Produto </button>
                    </div>
                    <div class="cards-grid dashboard-grid mb-4">
                        <div class="card"> <h3 class="card-title">Custo Total do Estoque</h3> <p class="card-value">R$ 4.800,00</p> </div>
                        <div class="card"> <h3 class="card-title">Peças em Estoque</h3> <p class="card-value">57</p> </div>
                        <div class="card"> <h3 class="card-title">Lucro Previsto do Estoque</h3> <p class="card-value">R$ 8.239,30</p> </div>
                    </div>
                    <div class="cards-grid two-cols mb-4">
                        <div class="info-card"> <p>Produto com <strong>MAIOR</strong> estoque: <strong>Vestido Rosa (32 un.)</strong></p> </div>
                        <div class="info-card"> <p>Produto com <strong>MENOR</strong> estoque: <strong>Saia Midi (25 un.)</strong></p> </div>
                    </div>
                    <hr/>
                    <div id="product-card-container" class="product-card-grid"></div>
                </section>
                
                <!-- ### PRECIFICAR PAGE ### -->
                <section id="precificar-page" class="page">
                    <div class="page-header"> <h2 class="page-title">Calculadoras de Preço</h2> </div>
    
                    <div class="info-card mb-4">
                        <p>Use estas ferramentas para encontrar o preço de venda ideal. O <strong>Custo Total Unitário</strong> (<span id="precificar-base-cost" style="font-family: var(--font-primary);">R$ 0,00</span>) já foi calculado com base nas suas <a href="#despesas" class="nav-link" style="display: inline; padding: 0; color: var(--pink); text-decoration: underline;">despesas</a>. </p>
                    </div>
                    
                    <div class="cards-grid two-cols">
                        <!-- Calculadora Inteligente -->
                        <div class="card">
                            <h3 class="card-title">Calculadora Inteligente</h3>
                            <p class="info-text">Comece com seus custos e defina sua margem de lucro para descobrir o preço de venda ideal.</p>
                            
                            <div id="smart-calculator-form">
                                <div class="form-group">
                                    <label for="smart-product-cost">Custo de Aquisição do Produto (R$)</label>
                                    <input type="number" id="smart-product-cost" step="0.01" placeholder="Ex: 50.00">
                                </div>
    
                                <div class="pricing-slider-container">
                                    <label for="smart-profit-slider" class="form-group">Margem de Lucro Desejada</label>
                                    <input type="range" id="smart-profit-slider" min="0" max="300" value="100" class="mt-4">
                                </div>
    
                                <div class="pricing-result-card">
                                    <div class="result-label">Preço de Venda Sugerido</div>
                                    <div id="smart-suggested-price" class="result-value">R$ 0,00</div>
                                    <div class="result-details">
                                        <div> <span class="result-label">Lucro (%)</span> <div id="smart-profit-percentage">100%</div> </div>
                                        <div> <span class="result-label">Lucro (R$)</span> <div id="smart-profit-value">R$ 0,00</div> </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Calculadora Inversa -->
                        <div class="card">
                            <h3 class="card-title">Calculadora Inversa</h3>
                             <p class="info-text">Comece com o preço de venda (definido por você ou pelo mercado) para descobrir qual será seu lucro real.</p>
    
                             <div id="inverse-calculator-form">
                                <div class="form-group">
                                    <label for="inverse-product-cost">Custo de Aquisição do Produto (R$)</label>
                                    <input type="number" id="inverse-product-cost" step="0.01" placeholder="Ex: 50.00">
                                </div>
                                <div class="form-group">
                                    <label for="inverse-selling-price">Preço de Venda do Produto (R$)</label>
                                    <input type="number" id="inverse-selling-price" step="0.01" placeholder="Ex: 129.90">
                                </div>
    
                                <div class="pricing-result-card" style="background-image: linear-gradient(to right, var(--blue), var(--pink));">
                                    <div class="result-label">Seu Lucro Será</div>
                                    <div id="inverse-profit-value" class="result-value">R$ 0,00</div>
                                    <div class="result-details">
                                        <div> <span class="result-label">Margem (%)</span> <div id="inverse-profit-margin">0%</div> </div>
                                        <div> <span class="result-label">Custo Total</span> <div id="inverse-total-cost">R$ 0,00</div> </div>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </div>
                </section>
    
                <!-- ### DESPESAS PAGE ### -->
                <section id="despesas-page" class="page">
                     <div class="page-header"> <h2 class="page-title">Minhas Despesas</h2> </div>
                    <div class="cards-grid dashboard-grid mb-4">
                        <div class="card"> <h3 class="card-title card-title-small">Custo Fixo Total</h3> <p id="total-fixed-cost-display" class="card-value">R$ 0,00</p> </div>
                        <div class="card"> <h3 class="card-title card-title-small">Custo Variável Unit. Total</h3> <p id="total-variable-cost-display" class="card-value">R$ 0,00</p> </div>
                         <div class="card calculator-card"> <h3 class="card-title card-title-small">Custo Total Unitário</h3> <p id="total-unit-cost-display-top" class="card-value">R$ 0,00</p> </div>
                    </div>
                    <div class="cards-grid two-cols">
                        <div class="card">
                            <div class="page-header" style="margin-bottom: 0.5rem;">
                                 <h3 class="card-title" style="margin-bottom: 0;">Custos Fixos</h3>
                                 <button class="btn btn-secondary" id="add-fixed-expense-btn">Adicionar</button>
                            </div>
                            <p class="info-text">Gastos que não mudam com o volume de vendas. Ex: Aluguel, internet, salários.</p>
                            <ul id="fixed-expense-list" class="expense-list">
                                <!-- Fixed expenses will be rendered here by JS -->
                            </ul>
                        </div>
                        <div class="card">
                            <div class="page-header" style="margin-bottom: 0.5rem;">
                                <h3 class="card-title" style="margin-bottom: 0;">Custos Variáveis Unitários</h3>
                                <button class="btn btn-secondary" id="add-variable-expense-btn">Adicionar</button>
                            </div>
                            <p class="info-text">Gastos por cada produto vendido. Ex: Embalagem, mimos, taxa do cartão.</p>
                             <ul id="variable-expense-list" class="expense-list">
                                <!-- Variable expenses will be rendered here by JS -->
                             </ul>
                        </div>
                    </div>
                    <div class="card mt-4">
                        <h3 class="card-title text-center">Dados para Cálculo do Custo Unitário</h3>
                        <div class="cards-grid two-cols">
                             <div class="form-group"> <label for="monthly-shipping-cost">Custo de Frete (Mensal)</label> <input type="number" id="monthly-shipping-cost" placeholder="Ex: 150.00" value="150.00"> </div>
                            <div class="form-group"> <label for="items-sold-monthly">Peças Vendidas no Mês</label> <input type="number" id="items-sold-monthly" placeholder="Ex: 100" value="100"> </div>
                        </div>
                    </div>
                </section>
                
                <!-- ### FINANCEIRO PAGE ### -->
                <section id="financeiro-page" class="page">
                    <div class="page-header">
                        <h2 class="page-title">Controle Financeiro</h2>
                        <div class="form-actions">
                             <div class="form-group" style="margin-bottom: 0;">
                                 <select id="finance-period-filter"> <option value="monthly">Este Mês</option> <option value="weekly">Esta Semana</option> <option value="daily">Hoje</option> </select>
                             </div>
                             <button id="export-report-btn" class="btn btn-secondary"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px; height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg> Exportar Relatório </button>
                             <button id="add-manual-transaction-btn" class="btn btn-primary"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px; height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Lançamento Manual </button>
                        </div>
                    </div>
                    <div class="cards-grid summary-grid mb-4">
                        <div class="card"> <h3 class="card-title card-title-small">Contas a Receber</h3> <p class="card-value" style="color: var(--blue);">R$ 210,50</p> </div>
                        <div class="card"> <h3 class="card-title card-title-small">Contas a Pagar</h3> <p class="card-value" style="color: #ef4444;">R$ 899,90</p> </div>
                        <div class="card"> <h3 class="card-title card-title-small">Balanço do Mês</h3> <p class="card-value" style="color: var(--success);">R$ 6.720,10</p> </div>
                        <div class="card" style="background-color: var(--pink-light)"> <h3 class="card-title card-title-small">Saldo Previsto</h3> <p class="card-value" style="color: var(--pink);">R$ 6.030,70</p> </div>
                    </div>
                    <div class="cards-grid two-cols mb-4">
                        <div class="card"> <h3 class="card-title text-center">Fluxo de Caixa (Entradas vs. Saídas)</h3> <canvas id="cashFlowChart"></canvas> </div>
                        <div class="card"> <h3 class="card-title text-center">Despesas por Categoria</h3> <canvas id="expensesByCategoryChart"></canvas> </div>
                    </div>
                    <div class="cards-grid two-cols">
                        <div class="card">
                            <h3 class="card-title">Contas a Receber</h3>
                            <div class="table-wrapper">
                                <table id="receivables-table">
                                    <thead> <tr><th>Cliente</th><th>Vencimento</th><th>Valor</th><th>Ação</th></tr> </thead>
                                    <tbody>
                                        <tr data-due-date="2025-06-25"> <td>Carla Dias</td> <td>25/06/2025</td> <td>R$ 210,50</td> <td><button class="btn btn-success btn-sm action-btn">Recebido</button></td> </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                         <div class="card">
                            <h3 class="card-title">Contas a Pagar</h3>
                             <div class="table-wrapper">
                                <table id="payables-table">
                                    <thead> <tr><th>Descrição</th><th>Vencimento</th><th>Valor</th><th>Ação</th></tr> </thead>
                                    <tbody>
                                        <tr data-due-date="2025-07-10"> <td>Aluguel</td> <td>10/07/2025</td> <td>R$ 800,00</td> <td><button class="btn btn-primary btn-sm action-btn">Pagar</button></td> </tr>
                                        <tr data-due-date="2025-07-15"> <td>Internet</td> <td>15/07/2025</td> <td>R$ 99,90</td> <td><button class="btn btn-primary btn-sm action-btn">Pagar</button></td> </tr>
                                        <tr data-due-date="2025-06-25"> <td>Fornecedor de Roupas</td> <td>25/06/2025</td> <td>R$ 1.250,00</td> <td><button class="btn btn-primary btn-sm action-btn">Pagar</button></td> </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- ### CRM PAGE ### -->
                <section id="crm-page" class="page">
                    <div class="page-header">
                        <h2 class="page-title">Gestão de Clientes (CRM)</h2>
                        <div class="form-actions"> <button class="btn btn-secondary">Importar Lista</button> <button id="add-client-btn" class="btn btn-primary">Adicionar Cliente</button> </div>
                    </div>
                    <div class="cards-grid summary-grid mb-4">
                        <div class="card"> <h3 class="card-title card-title-small">Total de Clientes</h3> <p class="card-value">152</p> </div>
                        <div class="card"> <h3 class="card-title card-title-small">Aniversariantes do Mês</h3> <p class="card-value">8</p> </div>
                         <div class="card"> <h3 class="card-title card-title-small">Clientes Inativos (+3 meses)</h3> <p class="card-value">12</p> </div>
                        <div class="card" style="background-image: linear-gradient(to right, var(--gold-light), var(--gold));"> <h3 class="card-title card-title-small" style="color: var(--text-dark);">Cliente Campeão</h3> <p class="card-value-small" style="font-size: 1.2rem; font-weight: 700;">Ana Paula</p> <p class="card-value" style="font-size: 1.5rem; color: var(--text-dark);">R$ 1.850,00</p> </div>
                    </div>
                     <div class="card">
                         <div class="table-wrapper">
                             <table>
                                 <thead> <tr> <th>Nome</th> <th>Contato</th> <th>Última Compra</th> <th>Total Gasto</th> <th>Ticket Médio</th> <th>Ações</th> </tr> </thead>
                                 <tbody id="client-list-body">
                                     <!-- Client list will be rendered here by JS -->
                                 </tbody>
                             </table>
                         </div>
                     </div>
                </section>
                
                <!-- ### PERFIL PAGE (NOVO) ### -->
                <section id="perfil-page" class="page">
                    <div class="profile-header">
                        <label for="avatar-upload-input" class="profile-avatar">
                            <img id="avatar-preview" src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzOTAwNXwwfDF8c2VhcmNofDIyfHxwcm9maWxlJTIwZmVtYWxlfGVufDB8fHx8MTcxOTM1OTM3Mnww&ixlib=rb-4.0.3&q=80&w=200" alt="Avatar">
                            <div class="overlay">Alterar</div>
                        </label>
                        <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
                        <div class="profile-info">
                            <h2 id="profile-main-name">Maria's Closet</h2>
                            <p id="profile-main-email">maria.closet@email.com</p>
                        </div>
                    </div>
    
                    <div class="tabs">
                        <span class="tab-link active" data-tab="dados">Dados Pessoais/Empresa</span>
                        <span class="tab-link" data-tab="seguranca">Segurança</span>
                        <span class="tab-link" data-tab="assinatura">Assinatura</span>
                    </div>
    
                    <div id="tab-dados" class="tab-content active">
                        <form id="profile-data-form">
                            <div class="card">
                                <h3 class="card-title">Dados da Empresa</h3>
                                <div class="cards-grid two-cols">
                                    <div class="form-group">
                                        <label for="company-name">Nome da Empresa</label>
                                        <input type="text" id="company-name" value="Maria's Closet">
                                    </div>
                                    <div class="form-group">
                                        <label for="company-cnpj">CNPJ</label>
                                        <input type="text" id="company-cnpj" value="00.000.000/0001-00">
                                    </div>
                                </div>
                                 <h3 class="card-title" style="margin-top:1rem;">Dados Pessoais</h3>
                                 <div class="cards-grid two-cols">
                                    <div class="form-group">
                                        <label for="user-name">Seu Nome</label>
                                        <input type="text" id="user-name" value="Maria da Silva">
                                    </div>
                                    <div class="form-group">
                                        <label for="user-email">Seu E-mail</label>
                                        <input type="email" id="user-email" value="maria.closet@email.com">
                                    </div>
                                    <div class="form-group">
                                        <label for="user-phone">Seu Telefone</label>
                                        <input type="tel" id="user-phone" value="(62) 99999-8888">
                                    </div>
                                 </div>
                                 <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                                 </div>
                            </div>
                        </form>
                    </div>
                    <div id="tab-seguranca" class="tab-content">
                        <form id="profile-password-form">
                            <div class="card">
                                <h3 class="card-title">Alterar Senha</h3>
                                <div class="form-group">
                                    <label for="current-password">Senha Atual</label>
                                    <input type="password" id="current-password">
                                </div>
                                <div class="form-group">
                                    <label for="new-password">Nova Senha</label>
                                    <input type="password" id="new-password">
                                </div>
                                <div class="form-group">
                                    <label for="confirm-password">Confirmar Nova Senha</label>
                                    <input type="password" id="confirm-password">
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Alterar Senha</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div id="tab-assinatura" class="tab-content">
                        <div class="card">
                            <div class="subscription-card">
                                <div class="badge">PLANO ATUAL</div>
                                <h3>Lucro Certo PRO</h3>
                                <p>Sua assinatura está ativa e será renovada em <strong>25 de Julho de 2025</strong>.</p>
                                <div class="form-actions" style="justify-content: center;">
                                    <button class="btn btn-danger">Cancelar Assinatura</button>
                                    <button class="btn btn-primary">Gerenciar Assinatura</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>
    
    <div id="vendas-product-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="page-title mb-4">Adicionar Produto à Venda</h3>
            <div id="vendas-product-list" class="product-list">
                <!-- Products will be rendered here by JS -->
            </div>
        </div>
    </div>

    <div id="vendas-variation-modal" class="modal">
         <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="variation-modal-title" class="page-title mb-4">Selecionar Variação</h3>
            <div id="variation-list" class="product-list"></div>
        </div>
    </div>

    <div id="add-edit-product-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="product-modal-title" class="page-title mb-4">Adicionar Novo Produto</h3>
            <form id="new-product-form">
                <input type="hidden" id="product-id">
                <div class="modal-form-grid">
                    <div>
                        <div class="form-group">
                            <label for="product-image-input">Imagem do Produto</label>
                            <label for="product-image-input" class="image-preview-container" id="image-preview-container">
                                <img id="image-preview" src="" alt="Pré-visualização da imagem" class="hidden">
                                <span id="image-preview-text">Clique para enviar uma imagem</span>
                            </label>
                            <input type="file" id="product-image-input" accept="image/*" class="hidden">
                        </div>
                        <div class="form-group"> <label for="product-name">Nome do Produto</label> <input type="text" id="product-name" required placeholder="Ex: Vestido Floral"> </div>
                        <div class="form-group"> <label for="product-acquisition-cost">Custo de Aquisição do Produto (R$)</label> <input type="number" id="product-acquisition-cost" step="0.01" required placeholder="Valor pago pelo produto"> </div>
                        <fieldset class="fieldset">
                            <legend>Variações e Estoque</legend>
                            <div class="radio-group" id="variation-type-group">
                                <label><input type="radio" name="variationType" value="none" checked> Sem Variação</label>
                                <label><input type="radio" name="variationType" value="simple"> Variação Simples</label>
                                <label><input type="radio" name="variationType" value="combined"> Variação Combinada</label>
                            </div>
                            <div id="no-variation-section" class="mt-4">
                                <div class="form-group"> <label for="single-product-stock">Estoque</label> <input type="number" id="single-product-stock" placeholder="0"> </div>
                            </div>
                            <div id="simple-variation-section" class="hidden mt-4">
                                <div class="cards-grid two-cols">
                                    <div class="form-group"> <label for="simple-variation-name">Nome da Variação</label> <input type="text" id="simple-variation-name" placeholder="Ex: Tamanho"> </div>
                                    <div class="form-group"> <label for="simple-variation-values">Valores (separados por vírgula)</label> <input type="text" id="simple-variation-values" placeholder="Ex: P, M, G"> </div>
                                </div>
                                <button type="button" id="generate-simple-stock-btn" class="btn btn-secondary">Lançar Estoque</button>
                            </div>
                            <div id="combined-variation-section" class="hidden mt-4">
                                <p class="info-text" style="font-size: 0.8rem;">Crie combinações como Cor + Tamanho.</p>
                                <div class="form-group"> <label for="combined-variation-name-1">Nome da Variação 1</label> <input type="text" id="combined-variation-name-1" placeholder="Ex: Cor"> </div>
                                <div class="form-group"> <label for="combined-variation-values-1">Valores da Variação 1 (por vírgula)</label> <input type="text" id="combined-variation-values-1" placeholder="Ex: Preto, Branco"> </div>
                                <hr style="margin: 1rem 0;">
                                <div class="form-group"> <label for="combined-variation-name-2">Nome da Variação 2</label> <input type="text" id="combined-variation-name-2" placeholder="Ex: Tamanho"> </div>
                                <div class="form-group"> <label for="combined-variation-values-2">Valores da Variação 2 (por vírgula)</label> <input type="text" id="combined-variation-values-2" placeholder="Ex: P, M, G"> </div>
                                <button type="button" id="generate-combined-stock-btn" class="btn btn-secondary">Gerar Combinações e Lançar Estoque</button>
                            </div>
                        </fieldset>
                    </div>
                    <div>
                        <h3 class="card-title">Calculadora de Precificação</h3>
                        <div class="pricing-calculator-section">
                            <div class="form-group"> <label>Custo Total Unitário (Automático)</label> <input type="text" id="auto-unit-cost" readonly style="background: var(--border-color); font-weight: bold;"> </div>
                            <div class="form-group">
                                <label>Outros Custos em % (Ex: Taxa de maquininha)</label>
                                <div id="other-costs-container" class="other-costs-container"></div>
                                <button type="button" id="add-other-cost-btn" class="btn btn-secondary btn-sm mt-4">Adicionar outro custo (%)</button>
                            </div>
                        </div>
                        <div class="pricing-slider-container">
                            <label for="profit-margin-slider" class="form-group">Lucro sobre o Custo</label>
                            <input type="range" id="profit-margin-slider" min="0" max="300" value="100" class="mt-4">
                        </div>
                        <div class="pricing-result-card">
                            <div class="result-label">Preço de Venda Sugerido</div>
                            <div id="suggested-price" class="result-value">R$ 0,00</div>
                            <div class="result-details">
                                <div> <span class="result-label">Lucro (%)</span> <div id="profit-percentage">100%</div> </div>
                                <div> <span class="result-label">Lucro (R$)</span> <div id="profit-value">R$ 0,00</div> </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr />
                <div class="form-actions"> <button type="button" id="cancel-product-btn" class="btn btn-danger">Cancelar</button> <button type="submit" class="btn btn-primary">Salvar Produto</button> </div>
            </form>
        </div>
    </div>
    
    <div id="stock-variation-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="page-title mb-4">Lançar Estoque das Variações</h3>
             <div class="table-wrapper">
                <table>
                    <thead id="variation-table-head"></thead>
                    <tbody id="variation-stock-body"></tbody>
                </table>
            </div>
            <button type="button" id="save-stock-btn" class="btn btn-primary mt-4" style="width: 100%;">Salvar Estoque</button>
        </div>
    </div>

    <div id="add-expense-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="expense-modal-title" class="page-title mb-4">Adicionar Despesa</h3>
            <form id="expense-form">
                <input type="hidden" id="expense-id-hidden">
                <div class="form-group"> <label for="expense-name">Nome da Despesa</label> <input type="text" id="expense-name" required> </div>
                <div class="form-group"> <label for="expense-value">Valor (R$)</label> <input type="number" id="expense-value" step="0.01" required> </div>
                <div class="form-group">
                    <label for="expense-category">Categoria</label>
                    <select id="expense-category"> <option value="Fornecedores">Fornecedores</option> <option value="Marketing">Marketing</option> <option value="Aluguel">Aluguel</option> <option value="Embalagens">Embalagens</option> <option value="Outros">Outros</option> </select>
                </div>
                <div id="fixed-expense-fields">
                     <div class="form-group"> <label for="expense-due-date">Data de Vencimento</label> <input type="date" id="expense-due-date"> </div>
                     <div class="form-group"> <label for="expense-recurrence">Recorrência</label> <select id="expense-recurrence"> <option value="Mensal">Mensal</option> <option value="Parcelado">Parcelado</option> <option value="Única">Pagamento Único</option> </select> </div>
                </div>
                <input type="hidden" id="expense-type-hidden">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Salvar Despesa</button>
            </form>
        </div>
    </div>

    <div id="add-edit-client-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="client-modal-title" class="page-title mb-4">Adicionar Novo Cliente</h3>
            <form id="new-client-form">
                <input type="hidden" id="client-id">
                <div class="form-group"> <label for="client-name">Nome</label> <input type="text" id="client-name" required> </div>
                <div class="form-group"> <label for="client-phone">Telefone</label> <input type="tel" id="client-phone"> </div>
                <div class="form-group"> <label for="client-email">E-mail</label> <input type="email" id="client-email"> </div>
                <div class="form-group"> <label for="client-address">Endereço</label> <input type="text" id="client-address"> </div>
                <div class="form-group"> <label for="client-birthdate">Data de Nascimento</label> <input type="date" id="client-birthdate"> </div>
                <div class="form-actions"> <button type="button" class="btn btn-danger modal-close">Cancelar</button> <button type="submit" class="btn btn-primary">Salvar Cliente</button> </div>
            </form>
        </div>
    </div>

    <div id="client-history-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="client-history-modal-title" class="page-title mb-4">Histórico de Compras</h3>
            <div class="table-wrapper">
                <table>
                    <thead> <tr> <th>Data</th> <th>Itens Comprados</th> <th>Valor Total</th> </tr> </thead>
                    <tbody id="client-history-list"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="add-transaction-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="page-title mb-4">Adicionar Lançamento Manual</h3>
            <form id="transaction-form">
                <div class="form-group"> <label for="transaction-description">Descrição</label> <input type="text" id="transaction-description" required> </div>
                <div class="form-group"> <label for="transaction-value">Valor (R$)</label> <input type="number" id="transaction-value" step="0.01" required> </div>
                <div class="form-group">
                    <label for="transaction-type">Tipo de Lançamento</label>
                    <select id="transaction-type"> <option value="entrada">Entrada</option> <option value="saida">Saída</option> </select>
                </div>
                <div class="form-group"> <label for="transaction-date">Data</label> <input type="date" id="transaction-date" required> </div>
                 <button type="submit" class="btn btn-primary" style="width: 100%;">Salvar Lançamento</button>
            </form>
        </div>
    </div>
    
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="page-title mb-4">Lembretes e Avisos</h3>
            <ul id="notification-list"></ul>
        </div>
    </div>

    <div id="sale-receipt-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <div id="receipt-content"> <!-- Conteúdo para impressão/compartilhamento -->
                <h3 class="page-title mb-4">Recibo da Venda</h3>
                <p><strong>Cliente:</strong> <span id="receipt-client-name"></span></p>
                <p><strong>Data:</strong> <span id="receipt-date"></span></p>
                <hr style="margin: 1rem 0;">
                <h4>Produtos:</h4>
                <ul id="receipt-product-list" style="list-style: none; padding: 0.5rem 0;"></ul>
                <hr style="margin: 1rem 0;">
                <div class="summary-line"><span>Subtotal:</span> <span id="receipt-subtotal"></span></div>
                <div class="summary-line"><span>Desconto:</span> <span id="receipt-discount"></span></div>
                <div class="summary-line total"><span>Total:</span> <span id="receipt-total"></span></div>
            </div>
             <div class="form-actions mt-4">
                <button id="print-receipt-btn" class="btn btn-secondary">Imprimir Recibo</button>
                <button id="whatsapp-receipt-btn" class="btn btn-whatsapp">Enviar por WhatsApp</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ### LÓGICA DA EXPERIÊNCIA DE ENTRADA (NOVO) ### ---

            const entryWrapper = document.getElementById('entry-wrapper');
            const appWrapper = document.getElementById('app-wrapper');
            const landingPage = document.getElementById('landing-page');
            const authPage = document.getElementById('auth-page');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            document.getElementById('goto-login-btn').addEventListener('click', () => showAuthPage(true));
            document.getElementById('goto-register-btn').addEventListener('click', () => showAuthPage(false));
            document.getElementById('start-now-btn').addEventListener('click', () => showAuthPage(false));

            document.getElementById('show-register').addEventListener('click', () => toggleAuthForms(false));
            document.getElementById('show-login').addEventListener('click', () => toggleAuthForms(true));

            document.getElementById('login-btn').addEventListener('click', enterMainApp);
            document.getElementById('register-btn').addEventListener('click', enterMainApp);

            function showAuthPage(showLoginFirst) {
                landingPage.classList.remove('active');
                authPage.classList.add('active');
                toggleAuthForms(showLoginFirst);
            }
            
            function toggleAuthForms(showLogin) {
                loginForm.classList.toggle('active', showLogin);
                registerForm.classList.toggle('active', !showLogin);
            }

            function enterMainApp() {
                entryWrapper.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                initializeApp(); 
            }

            // --- ### LÓGICA DO APP PRINCIPAL (EXISTENTE) ### ---

            function initializeApp() {
                // --- Global Elements & State ---
                const menuToggle = document.querySelector('.menu-toggle');
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const navLinks = document.querySelectorAll('.nav-link');
                const pageTitle = document.getElementById('page-main-title');
                
                // --- ### INÍCIO DA CORREÇÃO (PERSISTÊNCIA DE DADOS) ### ---
                // --- Simulated Database with localStorage Persistence ---
                let db_products = [];
                let db_clients = [];
                let db_sales = [];
                let db_fixed_expenses = [];
                let db_variable_expenses = [];
                
                const saveData = () => {
                    localStorage.setItem('lucroCertoData', JSON.stringify({
                        products: db_products,
                        clients: db_clients,
                        sales: db_sales,
                        fixedExpenses: db_fixed_expenses,
                        variableExpenses: db_variable_expenses
                    }));
                };

                const loadData = () => {
                    const savedData = localStorage.getItem('lucroCertoData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        db_products = data.products || [];
                        db_clients = data.clients || [];
                        db_sales = data.sales || [];
                        db_fixed_expenses = data.fixedExpenses || [];
                        db_variable_expenses = data.variableExpenses || [];
                    } else {
                        // Load default data if nothing is saved
                        db_products = [
                            { id: 1, name: "Vestido Rosa", cost: 75.00, price: 150.00, stock: 5, variations: [{name:"Tamanho", values: ["P", "M"], stock: {"P": 2, "M": 3}}], image: 'https://images.unsplash.com/photo-1594613944354-bf9129598a85?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzOTAwNXwwfDF8c2VhcmNofDEzfHxwaW5rJTIwZHJlc3N8ZW58MHx8fHwxNzE5MzU4ODg4fDA&ixlib=rb-4.0.3&q=80&w=400' },
                            { id: 2, name: "Saia Midi", cost: 40.00, price: 89.90, stock: 8, variations: [], image: 'https://images.unsplash.com/photo-1591355416298-9e120eac0219?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzOTAwNXwwfDF8c2VhcmNofDV8fG1pZGklMjBza2lydHxlbnwwfHx8fDE3MTkzNTg5MTd8MA&ixlib=rb-4.0.3&q=80&w=400' },
                            { id: 3, name: "Calça Jeans", cost: 110.00, price: 210.50, stock: 3, variations: [], image: 'https://images.unsplash.com/photo-1602293589914-9e29544ddd5f?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzOTAwNXwwfDF8c2VhcmNofDF8fGplYW5zJTIwcGFudHN8ZW58MHx8fHwxNzE5MzU4OTQwfDA&ixlib=rb-4.0.3&q=80&w=400' }
                        ];
                        db_clients = [
                            {id: 1, name: "Ana Paula", phone: "(62) 99999-8888", email: "ana.paula@exemplo.com", address: "Rua das Flores, 123", birthdate: "1990-07-15", lastPurchase: "25/06/2025", totalSpent: 1850.00, ticket: 462.50},
                            {id: 2, name: "Beatriz Costa", phone: "(62) 98888-7777", email: "bia.costa@exemplo.com", address: "", birthdate: "1995-02-20", lastPurchase: "24/06/2025", totalSpent: 980.70, ticket: 163.45}
                        ];
                        db_fixed_expenses = [
                             { id: 1, name: 'Aluguel', value: 800.00, category: 'Aluguel', dueDate: '2025-07-10', recurrence: 'Mensal' },
                             { id: 2, name: 'Internet', value: 99.90, category: 'Outros', dueDate: '2025-07-15', recurrence: 'Mensal' }
                        ];
                        db_variable_expenses = [
                             { id: 1, name: 'Embalagem por produto', value: 1.00, category: 'Embalagens' },
                             { id: 2, name: 'Mimo por produto', value: 2.00, category: 'Marketing' }
                        ];
                        saveData(); // Save default data on first load
                    }
                };
                // --- ### FIM DA CORREÇÃO (PERSISTÊNCIA DE DADOS) ### ---


                let productVariationsData = {};
                let currentSaleItems = [];
                let productForVariationSelection = null;
                let charts = {};
    
                let isDashboardInitialized = false, isVendasInitialized = false, isProdutosInitialized = false, isPrecificarInitialized = false, isDespesasInitialized = false, isFinanceiroInitialized = false, isCrmInitialized = false, isPerfilInitialized = false;
    
                // --- Utility Functions ---
                const formatCurrency = (value) => { if (isNaN(value)) value = 0; return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); };
                const parseCurrency = (value) => { const s = String(value).trim(); if (s === '') return 0; if (!s.includes(',') && !s.includes('R$')) { const num = parseFloat(s); if (!isNaN(num)) return num; } let cleanString = s.replace('R$', '').trim().replace(/\./g, '').replace(',', '.'); const num = parseFloat(cleanString); return isNaN(num) ? 0 : num; };
                const showToast = (message) => { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'toast'; t.textContent = message; c.appendChild(t); setTimeout(() => { t.remove(); }, 3000); };
                const destroyChart = (id) => { if (charts[id]) { charts[id].destroy(); delete charts[id]; } };
                const closeModal = (modal) => modal.classList.remove('active');
                const openModal = (modal) => modal.classList.add('active');
                
                // --- Menu Logic ---
                const closeMenu = () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); };
                const openMenu = () => { sidebar.classList.add('active'); overlay.classList.add('active'); };
                menuToggle.addEventListener('click', openMenu);
                overlay.addEventListener('click', closeMenu);
    
                const showPage = (pageId, title) => {
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    const targetPage = document.getElementById(pageId);
                    if (targetPage) targetPage.classList.add('active');
                    
                    navLinks.forEach(link => { link.classList.remove('active'); if (link.getAttribute('href') === `#${pageId.replace('-page', '')}`) { link.classList.add('active'); } });
    
                    pageTitle.textContent = (pageId === 'dashboard-page') ? "Olá, Maria!" : title;
                    closeMenu();
    
                    // Initialize page-specific logic
                    if (pageId === 'dashboard-page' && !isDashboardInitialized) { initializeDashboardCharts(); isDashboardInitialized = true; }
                    if (pageId === 'vendas-page' && !isVendasInitialized) { initializeVendasPage(); isVendasInitialized = true; }
                    if (pageId === 'produtos-page' && !isProdutosInitialized) { initializeProdutosPage(); isProdutosInitialized = true; }
                    if (pageId === 'precificar-page' && !isPrecificarInitialized) { initializePrecificarPage(); isPrecificarInitialized = true; }
                    if (pageId === 'despesas-page') { if (!isDespesasInitialized) { initializeDespesasPage(); isDespesasInitialized = true; } else { updateDespesasCalculations(); } }
                    if (pageId === 'crm-page') { if (!isCrmInitialized) { initializeCrmPage(); isCrmInitialized = true; } else { renderClients(); } }
                    if (pageId === 'financeiro-page' && !isFinanceiroInitialized) { initializeFinanceiroPage(); isFinanceiroInitialized = true; }
                    if (pageId === 'perfil-page' && !isPerfilInitialized) { initializePerfilPage(); isPerfilInitialized = true; }
                };
    
                navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const pageId = link.getAttribute('href').substring(1) + '-page'; const title = link.querySelector('span').textContent; showPage(pageId, title); window.location.hash = link.getAttribute('href'); }); });
                
                function calculateTotalUnitCost() {
                    let totalFixed = 0; db_fixed_expenses.forEach(item => { totalFixed += item.value; });
                    let totalVariable = 0; db_variable_expenses.forEach(item => { totalVariable += item.value; });
                    
                    const monthlyShippingInput = document.getElementById('monthly-shipping-cost');
                    const itemsSoldInput = document.getElementById('items-sold-monthly');
                    
                    const monthlyShipping = monthlyShippingInput ? parseCurrency(monthlyShippingInput.value) : 0;
                    const itemsSold = itemsSoldInput ? parseInt(itemsSoldInput.value) || 1 : 1; 
                    
                    const unitFixedCost = itemsSold > 0 ? (totalFixed + monthlyShipping) / itemsSold : (totalFixed + monthlyShipping);
                    const totalUnitCost = unitFixedCost + totalVariable;
                    
                    return totalUnitCost;
                }
                
                function initializeDashboardCharts() {
                    destroyChart('goalChart'); const goalCtx = document.getElementById('goalChart').getContext('2d'); charts['goalChart'] = new Chart(goalCtx, { type: 'doughnut', data: { labels: ['Alcançado', 'Faltam'], datasets: [{ data: [7850, 2150], backgroundColor: ['#db1472', '#e5e7eb'], borderWidth: 2 }] }, options: { responsive: true, cutout: '70%', plugins: { legend: { display: false } } } });
                    destroyChart('topProductsChart'); const topProductsCtx = document.getElementById('topProductsChart').getContext('2d'); charts['topProductsChart'] = new Chart(topProductsCtx, { type: 'bar', data: { labels: ['Vestido Rosa', 'Saia Midi', 'Calça Jeans', 'Blusa Floral'], datasets: [{ label: 'Unidades Vendidas', data: [45, 32, 28, 15], backgroundColor: '#f8b81f', borderRadius: 4 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
                    destroyChart('topProfitChart'); const topProfitCtx = document.getElementById('topProfitChart').getContext('2d'); charts['topProfitChart'] = new Chart(topProfitCtx, { type: 'bar', data: { labels: ['Vestido Rosa', 'Calça Jeans', 'Saia Midi'], datasets: [{ label: 'Lucro Total (R$)', data: [1250, 980, 650], backgroundColor: ['#db1472', '#f8b81f', '#3b82f6'], borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } } });
                    destroyChart('costsChart'); const costsCtx = document.getElementById('costsChart').getContext('2d'); charts['costsChart'] = new Chart(costsCtx, { type: 'pie', data: { labels: ['Custo Fixo', 'Custo Variável', 'Frete'], datasets: [{ data: [899.90, 300, 150], backgroundColor: ['#ef4444', '#f8b81f', '#3b82f6'], hoverOffset: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
                }
                
                function updateSaleSummary() {
                    const subtotal = currentSaleItems.reduce((acc, item) => acc + item.price, 0);
                    const discountType = document.getElementById('discount-type').value;
                    const discountValue = parseFloat(document.getElementById('discount-value').value) || 0;
                    let discountAmount = 0;
    
                    if (discountType === 'percentage') {
                        discountAmount = subtotal * (discountValue / 100);
                    } else {
                        discountAmount = discountValue;
                    }
                    const total = subtotal - discountAmount;
    
                    document.getElementById('summary-subtotal').textContent = formatCurrency(subtotal);
                    document.getElementById('summary-discount').textContent = formatCurrency(discountAmount);
                    document.getElementById('summary-total').textContent = formatCurrency(total);
                    
                    const selectedList = document.getElementById('selected-products-list');
                    const noProductsMsg = document.getElementById('no-products-message');
                    
                    selectedList.innerHTML = '';
                    if (currentSaleItems.length === 0) {
                        selectedList.innerHTML = `<p id="no-products-message" class="text-light">Nenhum produto adicionado.</p>`;
                    } else {
                        currentSaleItems.forEach((item, index) => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'selected-product-item';
                            itemEl.innerHTML = `<span>${item.name} ${item.variation ? `(${item.variation})` : ''}</span> <span>${formatCurrency(item.price)}</span> <button data-index="${index}">&times;</button>`;
                            selectedList.appendChild(itemEl);
                        });
                    }
                }
    
    
                function addProductToSale(product, variation = null) {
                    currentSaleItems.push({ ...product, variation });
                    updateSaleSummary();
                    showToast(`${product.name} ${variation ? `(${variation})` : ''} adicionado!`);
                }
    
                function initializeVendasPage() {
                    const productModal = document.getElementById('vendas-product-modal');
                    const variationModal = document.getElementById('vendas-variation-modal');
                    const saleForm = document.getElementById('sale-form');
    
                    function resetSale() {
                        currentSaleItems = [];
                        saleForm.reset();
                        document.getElementById('installments-group').classList.add('hidden');
                        updateSaleSummary();
                    }
    
                    function renderSalesHistory() {
                        const tbody = document.getElementById('sales-history-body');
                        tbody.innerHTML = '';
                        db_sales.forEach(sale => {
                            const row = document.createElement('tr');
                            row.dataset.saleId = sale.id;
                            row.innerHTML = `
                                <td>${sale.client}</td>
                                <td>${sale.date}</td>
                                <td>${formatCurrency(sale.total)}</td>
                                <td><span class="${sale.status === 'Pago' ? 'status-paid' : 'status-pending'}">${sale.status}</span></td>
                                <td>
                                    <div class="table-actions">
                                        <button title="Excluir" class="delete-sale-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="pointer-events:none;"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                    </div>
                                </td>`;
                            tbody.appendChild(row);
                        });
                        saveData();
                    }
    
                    document.getElementById('show-customer-form-btn').addEventListener('click', () => { document.getElementById('new-customer-form').classList.toggle('hidden'); });
                    document.getElementById('advanced-customer-toggle').addEventListener('click', () => { document.getElementById('advanced-customer-fields').classList.toggle('hidden'); });
                    
                    // ### INÍCIO DA CORREÇÃO (Salvar cliente no PDV) ###
                    document.getElementById('save-customer-btn').addEventListener('click', () => {
                        const newName = document.getElementById('new-customer-name').value.trim();
                        const newPhone = document.getElementById('new-customer-phone').value.trim();
                        if (!newName || !newPhone) {
                            showToast("Nome e telefone são obrigatórios.");
                            return;
                        }

                        const newClient = {
                            id: Date.now(),
                            name: newName,
                            phone: newPhone,
                            email: document.getElementById('new-customer-email').value.trim(),
                            address: document.getElementById('new-customer-address').value.trim(),
                            birthdate: '',
                            lastPurchase: '',
                            totalSpent: 0,
                            ticket: 0
                        };
                        db_clients.push(newClient);
                        saveData();
                        renderClients(); // Atualiza a lista na página de CRM
                        
                        document.getElementById('customer-search').value = newName;
                        showToast("Cliente salvo com sucesso!");
                        document.getElementById('new-customer-form').classList.add('hidden');
                        document.getElementById('new-customer-form').querySelector('form')?.reset();
                    });
                     // ### FIM DA CORREÇÃO ###

                    document.getElementById('payment-method').addEventListener('change', (e) => {
                        document.getElementById('installments-group').classList.toggle('hidden', e.target.value !== 'credito');
                    });
    
                    document.getElementById('add-product-btn').addEventListener('click', () => {
                        const productListContainer = document.getElementById('vendas-product-list');
                        productListContainer.innerHTML = '';
                        db_products.forEach(p => {
                             const itemEl = document.createElement('div');
                             itemEl.className = 'product-item';
                             itemEl.dataset.id = p.id;
                             itemEl.innerHTML = `<span>${p.name} <small>(Estoque: ${p.stock})</small></span> <strong>${formatCurrency(p.price)}</strong>`;
                             productListContainer.appendChild(itemEl);
                        });
                        openModal(productModal);
                    });
    
                    productModal.addEventListener('click', (e) => {
                        const productItem = e.target.closest('.product-item');
                        if (!productItem) return;
                        
                        const productId = parseInt(productItem.dataset.id);
                        const product = db_products.find(p => p.id === productId);
    
                        if (product.variations && product.variations.length > 0 && product.variations[0].values) {
                            productForVariationSelection = product;
                            const variationListContainer = document.getElementById('variation-list');
                            variationListContainer.innerHTML = '';
                            document.getElementById('variation-modal-title').textContent = `Selecionar ${product.variations[0].name} de ${product.name}`;
                            product.variations[0].values.forEach(v => {
                                 const stockCount = product.variations[0].stock[v] || 0;
                                 const variationEl = document.createElement('div');
                                 variationEl.className = 'product-item';
                                 variationEl.dataset.variationName = v;
                                 variationEl.innerHTML = `<span>${v} <small>(Estoque: ${stockCount})</small></span>`;
                                 variationListContainer.appendChild(variationEl);
                            });
                            openModal(variationModal);
                        } else {
                            addProductToSale(product);
                        }
                        closeModal(productModal);
                    });
    
                    variationModal.addEventListener('click', (e) => {
                        const variationItem = e.target.closest('.product-item');
                        if (!variationItem) return;
                        const variationName = variationItem.dataset.variationName;
                        addProductToSale(productForVariationSelection, variationName);
                        closeModal(variationModal);
                    });
    
                    document.getElementById('selected-products-list').addEventListener('click', (e) => {
                        if (e.target.tagName === 'BUTTON') {
                            const index = parseInt(e.target.dataset.index);
                            currentSaleItems.splice(index, 1);
                            updateSaleSummary();
                        }
                    });
    
                    document.getElementById('discount-value').addEventListener('input', updateSaleSummary);
                    document.getElementById('discount-type').addEventListener('change', updateSaleSummary);
    
                    document.getElementById('finish-sale-btn').addEventListener('click', () => {
                        if (currentSaleItems.length === 0) { showToast("Adicione produtos para finalizar a venda."); return; }
                        
                        const newSale = {
                            id: db_sales.length + 1,
                            client: document.getElementById('customer-search').value || 'Cliente não identificado',
                            date: new Date().toLocaleDateString('pt-BR'),
                            total: parseCurrency(document.getElementById('summary-total').textContent),
                            status: document.getElementById('payment-method').value === 'carne' ? 'Pendente' : 'Pago',
                            items: [...currentSaleItems]
                        };
                        db_sales.push(newSale);
                        renderSalesHistory();
                        
                        const clientName = newSale.client;
                        const client = db_clients.find(c => c.name.toLowerCase() === clientName.toLowerCase());
                        const whatsappBtn = document.getElementById('whatsapp-receipt-btn');
                        whatsappBtn.dataset.clientPhone = client ? client.phone : '';

                        document.getElementById('receipt-client-name').textContent = newSale.client;
                        document.getElementById('receipt-date').textContent = newSale.date;
                        document.getElementById('receipt-subtotal').textContent = document.getElementById('summary-subtotal').textContent;
                        document.getElementById('receipt-discount').textContent = document.getElementById('summary-discount').textContent;
                        document.getElementById('receipt-total').textContent = document.getElementById('summary-total').textContent;
                        const receiptProductList = document.getElementById('receipt-product-list');
                        receiptProductList.innerHTML = '';
                        newSale.items.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.name} ${item.variation ? '('+item.variation+')' : ''} - ${formatCurrency(item.price)}`;
                            receiptProductList.appendChild(li);
                        });
                        openModal(document.getElementById('sale-receipt-modal'));
    
                        resetSale();
                    });
    
                    document.getElementById('sales-history-body').addEventListener('click', (e) => {
                        const target = e.target.closest('button');
                        if (!target) return;
                        const row = target.closest('tr');
                        const saleId = parseInt(row.dataset.saleId);
                        if (target.classList.contains('delete-sale-btn')) {
                            db_sales = db_sales.filter(s => s.id !== saleId);
                            renderSalesHistory();
                            showToast('Venda removida do histórico.');
                        }
                    });
    
                    document.getElementById('print-receipt-btn').addEventListener('click', () => {
                        window.print();
                    });

                    document.getElementById('whatsapp-receipt-btn').addEventListener('click', (e) => {
                        const phone = e.target.dataset.clientPhone;
                        if (!phone) {
                            showToast("Telefone do cliente não encontrado para envio.");
                            return;
                        }

                        const cleanPhone = "55" + phone.replace(/\D/g, '');

                        const clientName = document.getElementById('receipt-client-name').textContent;
                        const saleDate = document.getElementById('receipt-date').textContent;
                        const totalValue = document.getElementById('receipt-total').textContent;
                        let itemsText = "";
                        document.querySelectorAll('#receipt-product-list li').forEach(li => {
                            itemsText += `\n- ${li.textContent.replace(/\s-\sR\$.*$/, '').trim()}`;
                        });

                        const message = `Olá, ${clientName}!\n\nObrigada por comprar na Maria's Closet em ${saleDate}.\n\n*Resumo do seu pedido:*${itemsText}\n\n*Total:* ${totalValue}`;

                        const encodedMessage = encodeURIComponent(message);
                        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
                        
                        window.open(whatsappUrl, '_blank');
                    });
                    
                    renderSalesHistory();
                    updateSaleSummary();
                }
    
                function renderProducts() {
                    const container = document.getElementById('product-card-container');
                    if(!container) return;
                    container.innerHTML = '';
                    db_products.forEach(p => {
                        const card = document.createElement('div');
                        card.className = 'product-card';
                        card.dataset.productId = p.id;
                        card.innerHTML = `
                            <div class="product-card-image">
                                <img src="${p.image}" alt="${p.name}" onerror="this.style.display='none'; this.parentElement.innerHTML = '<span>Sem Imagem</span>';">
                            </div>
                            <div class="product-card-content">
                                 <div class="product-card-actions">
                                    <button title="Editar" class="edit-product-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="pointer-events: none;"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                    <button title="Excluir" class="delete-product-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="pointer-events: none;"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                </div>
                                <h4 class="product-card-name">${p.name}</h4>
                                <div class="product-card-details">
                                    <div><span class="detail-label">Estoque Total</span><span class="detail-value">${p.stock} un.</span></div>
                                    <div><span class="detail-label">Custo Unit.</span><span class="detail-value">${formatCurrency(p.cost)}</span></div>
                                    <div class="product-card-price"><span class="detail-label">Preço de Venda</span><span class="detail-value">${formatCurrency(p.price)}</span></div>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }
    
                function updateProductModalPrice() {
                    const cost = parseCurrency(document.getElementById('product-acquisition-cost').value);
                    const unitCost = calculateTotalUnitCost();
                    document.getElementById('auto-unit-cost').value = formatCurrency(unitCost);
                    
                    const profitMargin = parseInt(document.getElementById('profit-margin-slider').value);
                    
                    let otherCostsPercentage = 0;
                    document.querySelectorAll('#other-costs-container .dynamic-field').forEach(field => {
                        const percentage = parseFloat(field.querySelector('input[type="number"]').value) || 0;
                        otherCostsPercentage += percentage;
                    });
                    
                    const totalCost = cost + unitCost;
                    const divisor = 1 - (profitMargin / 100) - (otherCostsPercentage / 100);
                    
                    let finalPrice = (divisor > 0) ? totalCost / divisor : totalCost;
                    if (isNaN(finalPrice) || !isFinite(finalPrice)) finalPrice = 0;

                    const profitValue = finalPrice - totalCost;
    
                    document.getElementById('suggested-price').textContent = formatCurrency(finalPrice);
                    document.getElementById('profit-percentage').textContent = `${profitMargin}%`;
                    document.getElementById('profit-value').textContent = formatCurrency(profitValue);
                }
                
                function initializeProdutosPage() {
                    const productModal = document.getElementById('add-edit-product-modal');
                    const productForm = document.getElementById('new-product-form');
                    const stockModal = document.getElementById('stock-variation-modal');
                    
                    document.getElementById('open-add-product-modal-btn').addEventListener('click', () => {
                        productForm.reset();
                        document.getElementById('product-id').value = '';
                        document.getElementById('product-modal-title').textContent = 'Adicionar Novo Produto';
                        document.getElementById('image-preview').classList.add('hidden');
                        document.getElementById('image-preview-text').classList.remove('hidden');
                        document.getElementById('auto-unit-cost').value = formatCurrency(calculateTotalUnitCost());
                        updateProductModalPrice();
                        openModal(productModal);
                    });
                    document.getElementById('cancel-product-btn').addEventListener('click', () => closeModal(productModal));
    
                    document.getElementById('product-image-input').addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if(file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const preview = document.getElementById('image-preview');
                                const previewText = document.getElementById('image-preview-text');
                                preview.src = e.target.result;
                                preview.classList.remove('hidden');
                                previewText.classList.add('hidden');
                            }
                            reader.readAsDataURL(file);
                        }
                    });
    
                    document.getElementById('variation-type-group').addEventListener('change', (e) => {
                        document.getElementById('no-variation-section').classList.toggle('hidden', e.target.value !== 'none');
                        document.getElementById('simple-variation-section').classList.toggle('hidden', e.target.value !== 'simple');
                        document.getElementById('combined-variation-section').classList.toggle('hidden', e.target.value !== 'combined');
                    });
                    
                    document.getElementById('add-other-cost-btn').addEventListener('click', () => {
                        const container = document.getElementById('other-costs-container');
                        const field = document.createElement('div');
                        field.className = 'dynamic-field';
                        field.innerHTML = `<input type="text" placeholder="Nome do Custo (ex: Imposto)"><input type="number" step="0.01" placeholder="%"><button type="button" class="btn btn-danger">&times;</button>`;
                        container.appendChild(field);
                        field.querySelector('button').addEventListener('click', () => { field.remove(); updateProductModalPrice(); });
                        field.querySelector('input[type="number"]').addEventListener('input', updateProductModalPrice);
                    });
    
                    ['product-acquisition-cost', 'profit-margin-slider'].forEach(id => {
                        document.getElementById(id).addEventListener('input', updateProductModalPrice);
                    });
    
                    productForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const productId = document.getElementById('product-id').value;
                        const productData = {
                            name: document.getElementById('product-name').value,
                            cost: parseCurrency(document.getElementById('product-acquisition-cost').value),
                            price: parseCurrency(document.getElementById('suggested-price').textContent),
                            stock: parseInt(document.getElementById('single-product-stock').value) || 0,
                            variations: productVariationsData.variations || [],
                            image: document.getElementById('image-preview').src
                        };
                        
                        // ### INÍCIO DA CORREÇÃO (Edição de Produto) ###
                        if (productId) {
                            const index = db_products.findIndex(p => p.id == productId);
                            if(index !== -1) {
                                db_products[index] = { ...db_products[index], ...productData };
                                showToast("Produto atualizado com sucesso!");
                            }
                        } else {
                            productData.id = Date.now();
                            db_products.push(productData);
                            showToast("Produto salvo com sucesso!");
                        }
                        // ### FIM DA CORREÇÃO ###
                        
                        saveData();
                        renderProducts();
                        closeModal(productModal);
                    });
                    
                    document.getElementById('product-card-container').addEventListener('click', (e) => {
                        const target = e.target;
                        const card = target.closest('.product-card');
                        if (!card) return;
                        const productId = parseInt(card.dataset.productId);
    
                        if(target.closest('.edit-product-btn')) {
                            const product = db_products.find(p => p.id === productId);
                            if (!product) return;
    
                            document.getElementById('product-modal-title').textContent = 'Editar Produto';
                            document.getElementById('product-id').value = product.id;
                            document.getElementById('product-name').value = product.name;
                            document.getElementById('product-acquisition-cost').value = product.cost;
                            document.getElementById('image-preview').src = product.image;
                            document.getElementById('image-preview').classList.remove('hidden');
                            document.getElementById('image-preview-text').classList.add('hidden');
                            document.getElementById('single-product-stock').value = product.stock;
                            document.getElementById('auto-unit-cost').value = formatCurrency(calculateTotalUnitCost());
                            
                            updateProductModalPrice();
                            const totalCost = product.cost + calculateTotalUnitCost();
                            const profitMarginCalc = totalCost > 0 ? ((product.price - totalCost) / totalCost) * 100 : 100;
                            document.getElementById('profit-margin-slider').value = profitMarginCalc > 0 ? profitMarginCalc : 100;
                            updateProductModalPrice();
    
                            openModal(productModal);
    
                        } else if (target.closest('.delete-product-btn')) {
                             db_products = db_products.filter(p => p.id !== productId);
                             saveData();
                             renderProducts();
                             showToast('Produto excluído com sucesso.');
                        }
                    });
    
                     document.getElementById('generate-simple-stock-btn').addEventListener('click', () => {
                        const name = document.getElementById('simple-variation-name').value || "Variação";
                        const values = document.getElementById('simple-variation-values').value.split(',').map(v => v.trim()).filter(Boolean);
                        if (values.length === 0) { showToast("Insira os valores da variação."); return; }
                        
                        const head = document.getElementById('variation-table-head');
                        const body = document.getElementById('variation-stock-body');
                        head.innerHTML = `<tr><th>${name}</th><th>Estoque</th></tr>`;
                        body.innerHTML = '';
                        values.forEach(val => {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${val}</td><td><input type="number" data-variation-value="${val}" placeholder="0"></td>`;
                            body.appendChild(row);
                        });
    
                        productVariationsData = { type: 'simple', name, values };
                        openModal(stockModal);
                    });
    
                    document.getElementById('generate-combined-stock-btn').addEventListener('click', () => {
                        showToast("Função de estoque combinado ainda em desenvolvimento.");
                    });
    
                    document.getElementById('save-stock-btn').addEventListener('click', () => {
                         let totalStock = 0;
                         const stockData = {};
                         document.querySelectorAll('#variation-stock-body input').forEach(input => {
                             const value = parseInt(input.value) || 0;
                             stockData[input.dataset.variationValue] = value;
                             totalStock += value;
                         });
    
                         productVariationsData.stock = stockData;
                         document.getElementById('single-product-stock').value = totalStock;
                         showToast("Estoque das variações salvo temporariamente.");
                         closeModal(stockModal);
                    });
    
                    renderProducts();
                }
    
                function initializePrecificarPage() {
                     const smartProductCostInput = document.getElementById('smart-product-cost');
                     const smartProfitSlider = document.getElementById('smart-profit-slider');
                     const inverseProductCostInput = document.getElementById('inverse-product-cost');
                     const inverseSellingPriceInput = document.getElementById('inverse-selling-price');
                     
                     function updateAllPrecificarCalculators() {
                        const unitCost = calculateTotalUnitCost();
                        document.getElementById('precificar-base-cost').textContent = formatCurrency(unitCost);
                        
                        // Calculadora Inteligente
                        const smartCost = parseFloat(smartProductCostInput.value) || 0;
                        const smartTotal = smartCost + unitCost;
                        const smartMargin = parseInt(smartProfitSlider.value);
                        const smartPrice = smartTotal * (1 + (smartMargin / 100));
                        document.getElementById('smart-suggested-price').textContent = formatCurrency(smartPrice);
                        document.getElementById('smart-profit-percentage').textContent = `${smartMargin}%`;
                        document.getElementById('smart-profit-value').textContent = formatCurrency(smartPrice - smartTotal);
    
                        // Calculadora Inversa
                        const inverseCost = parseFloat(inverseProductCostInput.value) || 0;
                        const inversePrice = parseFloat(inverseSellingPriceInput.value) || 0;
                        const inverseTotal = inverseCost + unitCost;
                        const inverseProfit = inversePrice > 0 ? inversePrice - inverseTotal : 0;
                        const inverseMargin = inverseTotal > 0 && inversePrice > 0 ? (inverseProfit / inverseTotal) * 100 : 0;
                        document.getElementById('inverse-profit-value').textContent = formatCurrency(inverseProfit);
                        document.getElementById('inverse-total-cost').textContent = formatCurrency(inverseTotal);
                        document.getElementById('inverse-profit-margin').textContent = `${inverseMargin.toFixed(0)}%`;
                     };
                     
                     [smartProductCostInput, smartProfitSlider, inverseProductCostInput, inverseSellingPriceInput].forEach(el => { if(el) el.addEventListener('input', updateAllPrecificarCalculators); });
                     updateAllPrecificarCalculators(); // Run on initialization
                }
    
                function updateDespesasCalculations() {
                    const totalUnitCost = calculateTotalUnitCost();

                    let totalFixed = 0; db_fixed_expenses.forEach(item => { totalFixed += item.value; });
                    document.getElementById('total-fixed-cost-display').textContent = formatCurrency(totalFixed);
                    
                    let totalVariable = 0; db_variable_expenses.forEach(item => { totalVariable += item.value; });
                    document.getElementById('total-variable-cost-display').textContent = formatCurrency(totalVariable);
                    
                    document.getElementById('total-unit-cost-display-top').textContent = formatCurrency(totalUnitCost);
                }
    
                function initializeDespesasPage() {
                    const expenseModal = document.getElementById('add-expense-modal');
                    const expenseForm = document.getElementById('expense-form');
                    const fixedList = document.getElementById('fixed-expense-list');
                    const variableList = document.getElementById('variable-expense-list');
    
                    const renderExpenses = () => {
                        fixedList.innerHTML = '';
                        db_fixed_expenses.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'expense-item';
                            li.dataset.id = item.id;
                            li.innerHTML = `<div class="expense-info"><span>${item.name}</span><div class="details">Vence em: ${item.dueDate} (${item.recurrence})<span class="expense-category-tag">${item.category}</span></div></div><div class="table-actions"><strong>${formatCurrency(item.value)}</strong><button title="Editar" class="edit-expense-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;pointer-events:none;"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Z" /></svg></button><button title="Excluir" class="delete-expense-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;pointer-events:none;"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button></div>`;
                            fixedList.appendChild(li);
                        });
                        variableList.innerHTML = '';
                        db_variable_expenses.forEach(item => {
                             const li = document.createElement('li');
                             li.className = 'expense-item';
                             li.dataset.id = item.id;
                             li.innerHTML = `<div class="expense-info"><span>${item.name}</span><span class="expense-category-tag" style="background-color: var(--gold);">${item.category}</span></div><div class="table-actions"><strong>${formatCurrency(item.value)}</strong><button title="Editar" class="edit-expense-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;pointer-events:none;"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Z" /></svg></button><button title="Excluir" class="delete-expense-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;pointer-events:none;"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button></div>`;
                             variableList.appendChild(li);
                        });
                        updateDespesasCalculations();
                    }
    
                    const openExpenseModal = (type, id = null) => {
                        expenseForm.reset();
                        document.getElementById('expense-type-hidden').value = type;
                        document.getElementById('expense-id-hidden').value = id || '';
                        document.getElementById('fixed-expense-fields').classList.toggle('hidden', type !== 'fixed');
                        
                        if (id) {
                            const expense = (type === 'fixed' ? db_fixed_expenses : db_variable_expenses).find(e => e.id == id);
                            document.getElementById('expense-modal-title').textContent = "Editar Despesa";
                            document.getElementById('expense-name').value = expense.name;
                            document.getElementById('expense-value').value = expense.value;
                            document.getElementById('expense-category').value = expense.category;
                            if (type === 'fixed') {
                                document.getElementById('expense-due-date').value = expense.dueDate;
                                document.getElementById('expense-recurrence').value = expense.recurrence;
                            }
                        } else {
                            document.getElementById('expense-modal-title').textContent = type === 'fixed' ? "Adicionar Custo Fixo" : "Adicionar Custo Variável";
                        }
                        openModal(expenseModal);
                    };
    
                    document.getElementById('add-fixed-expense-btn').addEventListener('click', () => openExpenseModal('fixed'));
                    document.getElementById('add-variable-expense-btn').addEventListener('click', () => openExpenseModal('variable'));
                    
                    expenseForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const type = document.getElementById('expense-type-hidden').value;
                        const id = document.getElementById('expense-id-hidden').value;
                        const data = {
                            name: document.getElementById('expense-name').value,
                            value: parseFloat(document.getElementById('expense-value').value),
                            category: document.getElementById('expense-category').value
                        };
                        if (type === 'fixed') {
                            data.dueDate = document.getElementById('expense-due-date').value;
                            data.recurrence = document.getElementById('expense-recurrence').value;
                        }
                        
                        if(id) { // Editing
                            const db = type === 'fixed' ? db_fixed_expenses : db_variable_expenses;
                            const index = db.findIndex(item => item.id == id);
                            db[index] = {...db[index], ...data};
                        } else { // Adding
                            data.id = Date.now();
                            if(type === 'fixed') db_fixed_expenses.push(data);
                            else db_variable_expenses.push(data);
                        }
                        
                        saveData();
                        renderExpenses();
                        closeModal(expenseModal);
                        showToast("Despesa salva!");
                    });
    
                    [fixedList, variableList].forEach(list => {
                        list.addEventListener('click', e => {
                            const button = e.target.closest('button');
                            if (!button) return;
                            const li = button.closest('.expense-item');
                            const id = li.dataset.id;
                            const type = list.id === 'fixed-expense-list' ? 'fixed' : 'variable';
                            
                            if(button.classList.contains('edit-expense-btn')) {
                                openExpenseModal(type, id);
                            } else if (button.classList.contains('delete-expense-btn')) {
                                 if(type === 'fixed') db_fixed_expenses = db_fixed_expenses.filter(item => item.id != id);
                                 else db_variable_expenses = db_variable_expenses.filter(item => item.id != id);
                                 saveData();
                                 renderExpenses();
                                 showToast("Despesa excluída.");
                            }
                        });
                    });
                    
                    document.getElementById('monthly-shipping-cost').addEventListener('input', updateDespesasCalculations);
                    document.getElementById('items-sold-monthly').addEventListener('input', updateDespesasCalculations);
                    renderExpenses();
                }
                
                function initializeFinanceiroPage() {
                     destroyChart('cashFlowChart'); const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d'); charts['cashFlowChart'] = new Chart(cashFlowCtx, { type: 'bar', data: { labels: ['Março', 'Abril', 'Maio', 'Junho'], datasets: [ { label: 'Entradas', data: [5200, 6100, 7500, 7850], backgroundColor: 'rgba(34, 197, 94, 0.7)', borderColor: 'rgba(34, 197, 94, 1)', borderWidth: 1, borderRadius: 4 }, { label: 'Saídas', data: [1500, 1800, 1100, 1230], backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1, borderRadius: 4 } ] }, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
                     destroyChart('expensesByCategoryChart'); const categoryCtx = document.getElementById('expensesByCategoryChart').getContext('2d'); charts['expensesByCategoryChart'] = new Chart(categoryCtx, { type: 'pie', data: { labels: ['Fornecedores', 'Marketing', 'Aluguel', 'Embalagens', 'Outros'], datasets: [{ label: 'Despesas por Categoria', data: [1250, 250, 800, 120, 99.90], backgroundColor: ['#db1472', '#f8b81f', '#3b82f6', '#22c55e', '#8b5cf6'], hoverOffset: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
                     
                     document.getElementById('add-manual-transaction-btn').addEventListener('click', () => { openModal(document.getElementById('add-transaction-modal')); });
                     document.getElementById('transaction-form').addEventListener('submit', (e) => { e.preventDefault(); showToast("Lançamento salvo com sucesso!"); closeModal(document.getElementById('add-transaction-modal')); });
                     document.getElementById('export-report-btn').addEventListener('click', () => showToast('Relatório exportado!'));
                     document.getElementById('finance-period-filter').addEventListener('change', (e) => showToast(`Exibindo dados para: ${e.target.options[e.target.selectedIndex].text}`));
    
                     ['receivables-table', 'payables-table'].forEach(id => {
                         document.getElementById(id).addEventListener('click', e => {
                             if(e.target.classList.contains('action-btn')) {
                                 e.target.closest('tr').remove();
                                 showToast('Transação baixada com sucesso!');
                             }
                         })
                     });
                }
    
                function renderClients() {
                    const tbody = document.getElementById('client-list-body');
                    if(!tbody) return;
                    tbody.innerHTML = '';
                    db_clients.forEach(c => {
                        const row = document.createElement('tr');
                        row.dataset.id = c.id;
                        row.innerHTML = `
                             <td>${c.name}</td> <td>${c.phone}</td> <td>${c.lastPurchase}</td> <td>${formatCurrency(c.totalSpent)}</td> <td>${formatCurrency(c.ticket)}</td>
                             <td>
                                 <div class="table-actions">
                                    <button title="Histórico" class="history-client-btn"><svg style="pointer-events:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg> </button>
                                    <button title="Enviar WhatsApp" class="whatsapp-client-btn whatsapp-icon"><svg style="pointer-events:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .026 3.603.026 8.05c0 1.463.39 2.828 1.099 4.026l-1.1 4.099 4.192-1.098a7.92 7.92 0 0 0 3.79-.965h.004c4.368 0 7.97-3.602 7.97-8.047 0-2.22-.892-4.24-2.48-5.736Z"/></svg></button>
                                    <button title="Editar" class="edit-client-btn"><svg style="pointer-events:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
                                    <button title="Excluir" class="delete-client-btn"><svg style="pointer-events:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                                 </div>
                             </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
    
                function initializeCrmPage() {
                     const clientModal = document.getElementById('add-edit-client-modal');
                     const clientForm = document.getElementById('new-client-form');
                     document.getElementById('add-client-btn').addEventListener('click', () => { 
                         clientForm.reset(); 
                         document.getElementById('client-id').value = ''; 
                         document.getElementById('client-modal-title').textContent = 'Adicionar Novo Cliente';
                         openModal(clientModal); 
                     });
                     
                     clientForm.addEventListener('submit', e => {
                        e.preventDefault();
                        const id = document.getElementById('client-id').value;
                        const clientData = {
                            name: document.getElementById('client-name').value,
                            phone: document.getElementById('client-phone').value,
                            email: document.getElementById('client-email').value,
                            address: document.getElementById('client-address').value,
                            birthdate: document.getElementById('client-birthdate').value,
                        };
    
                        if (id) {
                            const index = db_clients.findIndex(c => c.id == id);
                            db_clients[index] = { ...db_clients[index], ...clientData };
                            showToast("Cliente atualizado com sucesso!");
                        } else {
                            clientData.id = Date.now();
                            clientData.lastPurchase = new Date().toLocaleDateString('pt-BR');
                            clientData.totalSpent = 0;
                            clientData.ticket = 0;
                            db_clients.push(clientData);
                            showToast("Cliente salvo com sucesso!");
                        }
                        saveData();
                        renderClients();
                        closeModal(clientModal);
                     });
                     
                     document.getElementById('client-list-body').addEventListener('click', (e) => {
                         const button = e.target.closest('button');
                         if (!button) return;
                         const row = button.closest('tr');
                         const id = row.dataset.id;
                         const client = db_clients.find(c => c.id == id);
    
                         if (button.classList.contains('edit-client-btn')) {
                             document.getElementById('client-modal-title').textContent = 'Editar Cliente';
                             document.getElementById('client-id').value = client.id;
                             document.getElementById('client-name').value = client.name;
                             document.getElementById('client-phone').value = client.phone;
                             document.getElementById('client-email').value = client.email;
                             document.getElementById('client-address').value = client.address;
                             document.getElementById('client-birthdate').value = client.birthdate;
                             openModal(clientModal);
                         } else if (button.classList.contains('delete-client-btn')) {
                             db_clients = db_clients.filter(c => c.id != id);
                             saveData();
                             renderClients();
                             showToast("Cliente excluído com sucesso.");
                         } else if (button.classList.contains('history-client-btn')) {
                             document.getElementById('client-history-modal-title').textContent = `Histórico de ${client.name}`;
                             const historyList = document.getElementById('client-history-list');
                             historyList.innerHTML = `<tr><td>20/06/2025</td><td>Vestido Rosa</td><td>R$ 150,00</td></tr><tr><td>15/05/2025</td><td>Saia Midi, Calça Jeans</td><td>R$ 300,40</td></tr>`;
                             openModal(document.getElementById('client-history-modal'));
                         } else if (button.classList.contains('whatsapp-client-btn')) {
                             showToast(`Iniciando conversa com ${client.name}...`);
                         }
                     });
    
                     renderClients();
                }
    
                function initializePerfilPage() {
                    const tabs = document.querySelectorAll('#perfil-page .tab-link');
                    const tabContents = document.querySelectorAll('#perfil-page .tab-content');
    
                    tabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            const target = document.querySelector("#tab-" + tab.dataset.tab);
                            
                            if (!target) {
                                console.error("Conteúdo da aba não encontrado para: ", tab.dataset.tab);
                                return;
                            }
    
                            tabContents.forEach(tc => tc.classList.remove('active'));
                            tabs.forEach(t => t.classList.remove('active'));
                            
                            target.classList.add('active');
                            tab.classList.add('active');
                        });
                    });
    
                    document.getElementById('avatar-upload-input').addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const preview = document.getElementById('avatar-preview');
                            preview.src = URL.createObjectURL(file);
                        }
                    });
    
                    document.getElementById('profile-data-form').addEventListener('submit', e => {
                        e.preventDefault();
                         const companyName = document.getElementById('company-name').value;
                         const userEmail = document.getElementById('user-email').value;
                         document.getElementById('profile-main-name').textContent = companyName;
                         document.getElementById('profile-main-email').textContent = userEmail;
                        showToast('Dados salvos com sucesso!');
                    });
    
                    document.getElementById('profile-password-form').addEventListener('submit', e => {
                        e.preventDefault();
                        showToast('Senha alterada com sucesso!');
                    });
                }
                
                // --- Modal Close Button Generic Handler ---
                document.querySelectorAll('.modal .modal-close').forEach(btn => { btn.addEventListener('click', (e) => { e.target.closest('.modal').classList.remove('active'); }); });
    
                // --- Initial Page Load (for main app) ---
                loadData();
                const currentHash = window.location.hash || '#dashboard';
                const initialPageId = currentHash.substring(1) + '-page';
                const initialLink = document.querySelector(`.nav-link[href='${currentHash}']`);
                const initialTitle = initialLink ? initialLink.querySelector('span').textContent : 'Dashboard';
                showPage(initialPageId, initialTitle);
            }
        });
    </script>

</body>
</html>
